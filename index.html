<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión TI · Reporte de fallas</title>

  <style>
    /* =========================================================
       TEMAS Y TOKENS
       - "light", "dark", "mint" son temas predefinidos
       - --accent puede sobreescribirse con un HEX personalizado
       ========================================================= */
    :root{
      --bg:#eef2ff; --card:#fff; --text:#0d1333; --muted:#51608b; --border:rgba(13,19,51,.12);
      --field:#fbfcff; --accent:#6aa3ff; --ok:#2b8a3e; --warn:#f08c00; --bad:#e03131;
      --stickyTop:72px; /* distancia bajo la barra superior pegajosa */
    }
    body[data-theme="dark"]{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9aa4bf; --border:rgba(255,255,255,.15);
      --field:#0b1220; --accent:#93c5fd;
    }
    body[data-theme="mint"]{
      --bg:#e6fff4; --card:#ffffff; --text:#0d1333; --muted:#4d6a61; --border:rgba(13,19,51,.12);
      --field:#f7fffb; --accent:#16a34a;
    }

    /* ====== base ====== */
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}

    /* =========================================================
       BARRA SUPERIOR
       - logo a la izquierda
       - identidad, clave y tema (compacto) a la derecha
       ========================================================= */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg, color-mix(in srgb, var(--bg) 82%, transparent), transparent);
      backdrop-filter:saturate(120%) blur(4px);
      border-bottom:1px solid color-mix(in srgb, var(--border) 60%, transparent);
    }
    .topbar{
      max-width:1680px;margin:0 auto;padding:8px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;min-height:56px;
    }
    /* Logo “camuflado” con el tema (más arriba, en la barra) */
    .logo{
      height:44px;object-fit:contain;opacity:.9;
      mix-blend-mode:multiply; /* se integra con el color del tema */
      filter:drop-shadow(0 2px 5px rgba(0,0,0,.06));
    }
    .actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .chip{font-size:.9rem;color:var(--muted)}
    .ctl{height:36px;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:var(--field);color:var(--text)}
    .btn-sm{height:36px;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer}
    #themePick{width:118px;height:36px} /* tamaño tipo “botón” */

    /* =========================================================
       LAYOUT PRINCIPAL
       ========================================================= */
    main{max-width:1680px;margin:8px auto 16px;padding:0 16px;display:grid;gap:16px}
    @media (min-width:1200px){
      main{grid-template-columns:640px 1fr}
    }

    /* =========================================================
       CARDS Y SECCIONES
       ========================================================= */
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(13,19,51,.08)}
    .card h2{
      margin:0;padding:16px 16px 0;
      position:sticky;top:0;z-index:2;
      background:linear-gradient(180deg,var(--card),color-mix(in srgb, var(--card) 70%, transparent));
      border-top-left-radius:16px;border-top-right-radius:16px;
    }
    .card .body{padding:16px}

    /* Columna izquierda y derecha pegajosas al mismo nivel */
    .stickyL{position:sticky;top:var(--stickyTop);align-self:start}
    .stickyR{position:sticky;top:var(--stickyTop);align-self:start;z-index:1}

    /* La tabla del lado derecho tiene su propio scroll */
    .table-wrap{
      max-height:calc(100vh - 340px);
      overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px;
      background:color-mix(in srgb, var(--card) 96%, transparent)
    }

    /* =========================================================
       FORMULARIO IZQUIERDA
       ========================================================= */
    form .grid{display:grid;gap:12px}
    @media(min-width:560px){form .grid{grid-template-columns:1fr 1fr}}
    label{font-size:.9rem;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--field);color:var(--text)}
    textarea{min-height:96px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.primary{border-color:color-mix(in srgb, var(--accent) 45%, var(--border))}
    #qSearch{width:260px}

    /* Bloque: “Ayuda rápida” para no dejar esa zona plana */
    .helper{
      margin-top:10px;display:grid;gap:10px;grid-template-columns:1fr 1fr;
    }
    .helper .box{
      border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--field)
    }
    .helper h4{margin:0 0 6px 0;font-size:.95rem;color:var(--muted)}
    .helper ul{margin:0;padding-left:18px}
    .helper li{margin:4px 0}

    /* Chips y plantillas */
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chipbtn{border:1px solid var(--border);background:var(--field);border-radius:999px;padding:6px 10px;font-size:.85rem;cursor:pointer}
    details{margin-top:6px}
    details summary{cursor:pointer;color:var(--muted)}

    /* =========================================================
       KPIs + TABLA
       ========================================================= */
    .kpis{display:grid;grid-template-columns:repeat(5,minmax(180px,1fr));gap:12px;margin:8px 0 10px}
    .kpi{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi .label{font-size:.88rem;color:var(--muted);white-space:nowrap}
    .kpi .val{font-weight:800;font-size:1.25rem}

    table{width:100%;border-collapse:separate;border-spacing:0 10px;color:var(--text)}
    thead th{position:sticky;top:0;background:var(--card);z-index:1;font-size:.85rem;color:var(--muted);text-align:left;padding:0 8px;white-space:nowrap}
    tbody tr{background:var(--card);border:1px solid var(--border)}
    tbody td{padding:10px 8px;vertical-align:top}

    .badge{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:.78rem;white-space:nowrap}
    .prio-alta{background:#fff5f5}.prio-media{background:#fff4e6}.prio-baja{background:#ebfbee}
    body[data-theme="dark"] .prio-alta{background:#402b2b}
    body[data-theme="dark"] .prio-media{background:#3e2f18}
    body[data-theme="dark"] .prio-baja{background:#1b3b2a}
    .e-abierto{color:var(--bad)}.e-proceso{color:var(--warn)}.e-cerrado{color:var(--ok)}.e-cancelado{color:#6b7280}

    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0 12px}
    .toolbar select{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--field)}
    .muted{color:var(--muted);font-size:.9rem}
    .notice{display:none;margin-top:10px;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
    footer{max-width:1680px;margin:6px auto 28px;padding:0 16px;color:var(--muted);font-size:.9rem}
    .hidden{display:none!important}
  </style>
</head>
<body data-theme="light">
  <!-- =========================================================
       BARRA SUPERIOR
       - logo arriba (izquierda), controles a la derecha
       ========================================================= -->
  <header>
    <div class="topbar">
      <div class="brand">
        <img class="logo" src="Imagen/logo-empresas.jpg"
             onerror="this.onerror=null;this.src='https://jose01ve.github.io/GESTION-TI/Imagen/logo-empresas.jpg';"
             alt="Logo INGETEC / SEDIC">
      </div>

      <div class="actions">
        <small id="whoami" class="chip">Identidad: (no detectada)</small>
        <input id="keyInput" class="ctl" placeholder="Clave (opcional)" style="width:160px">
        <button id="saveKey" class="btn-sm">Guardar</button>
        <button id="clearKey" class="btn-sm" title="Olvidar">✕</button>

        <!-- IMPORTANTE:
             - Si eliges 'light', 'dark' o 'mint' -> cambia el tema completo.
             - Si escribes un valor que EMPIECE por '#', se toma como color de acento
               (no cambia el tema, sólo --accent). Ej: #003f84               -->
        <select id="themePick" class="ctl" title="Tema o color HEX">
          <option value="light">Tema: Verde</option>
          <option value="dark">Tema: Oscuro</option>
          <option value="mint">Tema: Mint</option>
           <option value="blue">Tema: Azul</option>
           </select>
      </div>
    </div>
  </header>

  <main>
    <!-- =======================================================
         COLUMNA IZQUIERDA (STICKY): REPORTE USUARIO
         ======================================================= -->
    <div class="stickyL">
      <section class="card">
        <h2>REPORTE USUARIO</h2>
        <div class="body">
          <form id="formTicket" action="javascript:void(0)" autocomplete="off">
            <div class="grid">
              <div>
                <label for="analista">Analista Responsable *</label>
                <select id="analista" required></select>
              </div>

              <div class="hidden">
                <label for="correoAnalista">Correo analista</label>
                <input id="correoAnalista" readonly />
              </div>

              <div>
                <label for="categoria">Categoría *</label>
                <select id="categoria" required>
                  <option value="">Selecciona…</option>
                  <option>Red</option><option>Hardware</option><option>Software</option>
                  <option>Correo</option><option>Impresión</option><option>Mantenimiento</option><option>Otro</option>
                </select>
              </div>

              <div>
                <label for="falla">Servicio prestado *</label>
                <select id="falla" required>
                  <option value="">Selecciona…</option>
                  <option>Soporte a equipos informáticos</option>
                  <option>Configuración equipo</option>
                  <option>Desbloquear cuenta de red</option>
                  <option>Préstamo Video Beam / Préstamo equipo</option>
                  <option>Crear acta</option>
                  <option>Instalación de PC-Dis \ Préstamo de equipo \ Dispositivo</option>
                  <option>Reposición de equipo</option>
                  <option>Retiro de equipo a usuario</option>
                  <option>Traslado de puesto</option>
                  <option>Instalación de software - Desinstalación \ Traslado SW</option>
                  <option>Desbloqueo punto de red</option>
                  <option>Adquisición de Software y Hardware</option>
                  <option>Asignación de puesto nuevo</option>
                  <option>Creación de cuentas de red</option>
                  <option>Eliminación de cuentas de red</option>
                  <option>Crear cuenta de correo \ Eliminar</option>
                  <option>Actualización de datos \ Información</option>
                  <option>Inventario de Equipos</option>
                  <option>Inventario de software</option>
                  <option>Actualización de cuentas de red</option>
                  <option>Asignar Permiso en servidores \ Retirar permisos</option>
                  <option>Permisos en Unidades compartidas</option>
                  <option>Soporte equipos CONSORCIO</option>
                  <option>Auditoria desde TIC a Interventoría</option>
                  <option>Instalación de Guayas</option>
                  <option>Backups información</option>
                  <option>Resolución de ECOS</option>
                  <option>Actualización de carpetas de información general</option>
                  <option>Actualización de información CADD</option>
                  <option>Capacitación</option>
                  <option>Reposición de equipos EPM</option>
                  <option>Asesoría general</option>
                  <option>Permisos en Skype Empresarial</option>
                  <option>Desinstalación de programas</option>
                  <option>Requerimiento de Impresión</option>
                  <option>Gestión en Vault</option>
                  <option>Permisos VPN</option>
                  <option>Gestión en obra</option>
                  <option>Crear cuenta de correo</option>
                  <option>Entrega de equipo por reintegro o reposición</option>
                  <option>Configurar Dispositivo móvil</option>
                  <option>Marcación de puestos</option>
                  <option>Recuperación de información</option>
                  <option>Gestión aplicaciones</option>
                </select>
              </div>

              <div class="ac">
                <label for="usuario">Usuario quien reporta *</label>
                <input id="usuario" placeholder="Escribe nombre o apellido" required />
                <ul id="acList" class="ac-list" hidden></ul>
                <small class="help">Escribe y elige entre las sugerencias.</small>
              </div>

              <div>
                <label for="prioridad">Prioridad *</label>
                <select id="prioridad" required>
                  <option value="">Selecciona…</option><option>Alta</option><option>Media</option><option>Baja</option>
                </select>
              </div>

              <div>
                <label for="adj">Adjunto (opcional)</label>
                <input id="adj" type="file" accept="image/*" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label for="descripcion">Descripción (opcional)</label>
              <textarea id="descripcion" placeholder="Describe el problema reportado…"></textarea>
            </div>

            <div id="notice" class="notice"></div>
            <div class="row">
              <button class="btn primary" type="submit">➕ Guardar reporte</button>
              <button class="btn" type="reset">↺ Limpiar</button>
              <!-- Buscador que filtra la tabla de la derecha -->
              <input id="qSearch" class="ctl" placeholder="Buscar tickets (ID, categoría, falla, usuario)">
            </div>

            <!-- Accesos rápidos + plantillas -->
            <div class="chips">
              <button type="button" class="chipbtn" data-prio="Alta">Prioridad: Alta</button>
              <button type="button" class="chipbtn" data-prio="Media">Prioridad: Media</button>
              <button type="button" class="chipbtn" data-prio="Baja">Prioridad: Baja</button>
              <details>
                <summary>Plantillas de descripción</summary>
                <div class="chips" style="margin-top:6px">
                  <button type="button" class="chipbtn tpl" data-text="Usuario no puede iniciar sesión. Se valida credencial y restablece acceso.">Login / restablecer</button>
                  <button type="button" class="chipbtn tpl" data-text="Se instala y configura software requerido por el usuario. Pruebas OK.">Instalación de software</button>
                  <button type="button" class="chipbtn tpl" data-text="Equipo presenta lentitud. Limpieza, actualización y pruebas de rendimiento.">Mantenimiento / performance</button>
                </div>
              </details>
            </div>

            <!-- Bloque profesional para “rellenar” con valor -->
            <div class="helper">
              <div class="box">
                <h4>Checklist antes de crear</h4>
                <ul>
                  <li>Confirmar datos del usuario y equipo.</li>
                  <li>Clasificar correctamente <em>Categoría</em> y <em>Servicio prestado</em>.</li>
                  <li>Adjuntar evidencia (si aplica).</li>
                  <li>Describir el impacto (usuarios/áreas afectadas).</li>
                  <li>Estimar prioridad (Alta/Media/Baja) según impacto.</li>
                </ul>
              </div>
              <div class="box">
                <h4>Leyenda rápida</h4>
                <ul>
                  <li><span class="badge prio-alta">Alta</span> incidente crítico o bloqueo.</li>
                  <li><span class="badge prio-media">Media</span> afecta tareas, tiene alternativa.</li>
                  <li><span class="badge prio-baja">Baja</span> consulta o mantenimiento.</li>
                </ul>
              </div>
            </div>
          </form>
        </div>
      </section>
    </div>

    <!-- =======================================================
         COLUMNA DERECHA (STICKY): ESTADO + FILTROS + TABLA SCROLL
         ======================================================= -->
    <section class="card stickyR">
      <h2>ESTADO DE REPORTE</h2>
      <div class="body">
        <div class="toolbar">
          <span class="muted">Vista:</span>
          <select id="viewSelect">
            <option value="mis">Asignados a mí</option>
            <option value="todos">Todos (admin)</option>
          </select>

          <span class="muted">Analista:</span>
          <select id="analystSelect">
            <option value="">Todos</option>
            <option>Jose Salas</option>
            <option>Sebastián Cataño</option>
            <option>Sebastián Posada</option>
            <option>Pablo Calle</option>
          </select>

          <span class="muted">Estado:</span>
          <select id="statusSelect">
            <option value="">Todos</option>
            <option value="pendientes">Pendientes</option>
            <option value="Abierto">Abierto</option>
            <option value="En Proceso">En Proceso</option>
            <option value="Cerrado">Cerrado</option>
            <option value="Cancelado">Cancelado</option>
          </select>

          <span class="muted">Mes:</span>
          <select id="monthSelect"><option value="">Todos</option></select>

          <span id="syncBadge" class="muted">Fuente: —</span>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="label">Total</div><div class="val" id="kpiTotal">0</div></div>
          <div class="kpi"><div class="label">Abiertos</div><div class="val" id="kpiAb">0</div></div>
          <div class="kpi"><div class="label">En proceso</div><div class="val" id="kpiPr">0</div></div>
          <div class="kpi"><div class="label">Cerrados</div><div class="val" id="kpiCe">0</div></div>
          <div class="kpi"><div class="label">Cancelados</div><div class="val" id="kpiCa">0</div></div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ID</th><th>Analista</th><th>Categoría</th><th>Falla</th><th>Usuario</th>
                <th>Prioridad</th><th>Estado</th><th>Fecha</th><th>Motivo</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer>⚡ App HTML sincroniza con Google Sheets. Eliminación deshabilitada; usar estado “Cancelado”.</footer>

  <script>
  (function(){
    'use strict';

    /* =========================================================
       CONFIG
       ========================================================= */
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyS998s7srjCkRE1R3CThvsKhIvA-gBTSB7072CLDUdgwI80Az6Kz_o0wRXB9ITHSwGdw/exec';
    const AUTO_REFRESH_MS = 30000;

    const ANALISTAS = [
      { nombre:'Jose Salas',        email:'jsalas@sedic.com.co' },
      { nombre:'Sebastián Cataño',  email:'scatano@sedic.com.co' },
      { nombre:'Sebastián Posada',  email:'sposada@sedic.com.co' },
      { nombre:'Pablo Calle',       email:'soportesistemasve@gmail.com' }
    ];

    const USUARIOS = [
      'Marcela Pareja','Juan Carlos Betancur','Diego Guerrero','Heidy Zambrano',
      'Jairo Pelaez','Oscar Álvarez','Laura Mejía','Carlos Ramírez','Diana Pérez',
      'Lina Areiza','María López','Andrés Gómez','Sofía Ríos','Mario Velez','Aide',
      'Verónica Zapata','Jhon Madrid','Juan Carlos Betancur'
    ];

    /* =========================================================
       DOM + ESTADO LOCAL
       ========================================================= */
    const $ = s => document.querySelector(s);
    const notice = $('#notice');
    const tbody = $('#tbody');
    const who = $('#whoami');
    const syncBadge = $('#syncBadge');
    const form = $('#formTicket');
    const qSearch = $('#qSearch');

    let ticketsLocal = loadLocal();
    let ticketsRemote = null;
    let lastSource = 'Local';
    let identity = null;
    let AUTH_KEY = '';

    const kpi = {
      total: $('#kpiTotal'), ab: $('#kpiAb'), pr: $('#kpiPr'), ce: $('#kpiCe'), ca: $('#kpiCa')
    };

    /* ===== helpers ===== */
    function loadLocal(){ try{ return JSON.parse(localStorage.getItem('tickets_fallas_v6'))||[] }catch{ return [] } }
    function saveLocal(v){ localStorage.setItem('tickets_fallas_v6', JSON.stringify(v)); }
    const norm = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    const esc  = s => String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
    const badge = p => `<span class="badge ${p==='Alta'?'prio-alta':p==='Media'?'prio-media':'prio-baja'}">${p||''}</span>`;
    const tagE  = e => { const s=String(e||''); const cls=(s==='Abierto')?'e-abierto':(s==='En Proceso')?'e-proceso':(s==='Cerrado')?'e-cerrado':'e-cancelado'; return `<strong class="${cls}">${s}</strong>`; };
    const fmt  = iso => { const d=(iso instanceof Date)?iso:new Date(iso); return isNaN(d)?'':d.toLocaleString(); };
    function show(msg, kind='ok'){ notice.style.display='block'; notice.textContent=msg; notice.style.borderColor=(kind==='ok')?'#b2f2bb':'#ffc9c9'; setTimeout(()=> notice.style.display='none', 2000); }

    /* =========================================================
       TEMA / COLOR DE ACENTO
       - Si el valor del select empieza por '#', se aplica a --accent
       - Si es 'light' | 'dark' | 'mint' => cambia el data-theme
       ========================================================= */
    const themePick = $('#themePick');
    (function initTheme(){
      const savedTheme = localStorage.getItem('ui_theme') || 'light';
      const savedAccent = localStorage.getItem('ui_accent') || '';
      document.body.setAttribute('data-theme', savedTheme);
      if (savedAccent) document.documentElement.style.setProperty('--accent', savedAccent);
      themePick.value = savedAccent || savedTheme;
      themePick.addEventListener('change', ()=>{
        const val = themePick.value.trim();
        if (val.startsWith('#')){
          document.documentElement.style.setProperty('--accent', val);
          localStorage.setItem('ui_accent', val);
        } else {
          document.body.setAttribute('data-theme', val);
          localStorage.setItem('ui_theme', val);
        }
      });
    })();

    /* =========================================================
       CLAVE (opcional) para pruebas externas
       ========================================================= */
    const keyInput = $('#keyInput'), saveKeyBtn = $('#saveKey'), clearKeyBtn = $('#clearKey');
    (function initKey(){
      const urlKey = new URLSearchParams(location.search).get('key') || '';
      const stored = localStorage.getItem('auth_key') || '';
      AUTH_KEY = urlKey || stored || '';
      if (urlKey && urlKey !== stored) localStorage.setItem('auth_key', urlKey);
      keyInput.value = AUTH_KEY;
    })();
    saveKeyBtn.addEventListener('click', ()=>{ AUTH_KEY=keyInput.value.trim(); localStorage.setItem('auth_key', AUTH_KEY); fetchWhoAmI().then(fetchRemote); });
    clearKeyBtn.addEventListener('click', ()=>{ AUTH_KEY=''; keyInput.value=''; localStorage.removeItem('auth_key'); fetchWhoAmI().then(fetchRemote); });

    /* =========================================================
       CATÁLOGO ANALISTAS (email oculto)
       ========================================================= */
    (function initAnalistas(){
      const sel = $('#analista');
      sel.innerHTML = '<option value="">Selecciona…</option>' + ANALISTAS.map(a=>`<option value="${a.nombre}">${a.nombre}</option>`).join('');
      sel.addEventListener('change', ()=>{
        const a = ANALISTAS.find(x=>x.nombre===sel.value);
        $('#correoAnalista').value = a ? a.email : '';
      });
    })();

    /* =========================================================
       AUTOCOMPLETE USUARIOS (nombre o apellido)
       ========================================================= */
    const inputUsuario = $('#usuario'); const acList = $('#acList');
    function filtraUsuarios(q){ const n=norm(q); if(!n) return []; return USUARIOS.filter(u=>norm(u).includes(n)).slice(0,8); }
    function pintaLista(items){
      if (!items.length){ acList.hidden=true; acList.innerHTML=''; return; }
      acList.innerHTML = items.map((t,i)=>`<li ${i===0?'aria-selected="true"':''}>${t}</li>`).join('');
      acList.hidden = false;
    }
    inputUsuario.addEventListener('input', ()=> pintaLista(filtraUsuarios(inputUsuario.value)));
    inputUsuario.addEventListener('focus', ()=> pintaLista(filtraUsuarios(inputUsuario.value)));
    document.addEventListener('click', (e)=>{
      if (e.target.closest('#acList li')){ inputUsuario.value = e.target.textContent; acList.hidden = true; }
      else if(!e.target.closest('.ac')) { acList.hidden = true; }
    });

    /* =========================================================
       FILTROS DE LA DERECHA
       ========================================================= */
    const viewSelect = $('#viewSelect'), analystSelect = $('#analystSelect'), statusSelect = $('#statusSelect'), monthSelect = $('#monthSelect');

    (function fillMonths(){
      const now = new Date(); const items = ['<option value="">Todos</option>'];
      for (let i=0;i<12;i++){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        const label = d.toLocaleDateString('es-CO', { month:'long', year:'numeric' });
        items.push(`<option value="${ym}">${label}</option>`);
      }
      monthSelect.innerHTML = items.join('');
    })();

    (function initView(){
      const saved = JSON.parse(localStorage.getItem('tickets_view')||'{}');
      viewSelect.value   = saved.view || 'mis';
      analystSelect.value= saved.analyst || '';
      statusSelect.value = saved.status || '';
      monthSelect.value  = saved.month || '';
    })();
    function persistView(){ localStorage.setItem('tickets_view', JSON.stringify({ view:viewSelect.value, analyst:analystSelect.value, status:statusSelect.value, month:monthSelect.value })); }
    [viewSelect,analystSelect,statusSelect,monthSelect].forEach(el => el.addEventListener('change', ()=>{ persistView(); fetchRemote(); }));

    /* =========================================================
       RENDER
       ========================================================= */
    function computeCounters(rows){
      const c = { total:rows.length, abiertos:0, en_proceso:0, cerrados:0, cancelados:0 };
      rows.forEach(t=>{ const s=String(t.estado||'').toLowerCase();
        if(s==='abierto') c.abiertos++; else if(s==='en proceso') c.en_proceso++; else if(s==='cerrado') c.cerrados++; else if(s==='cancelado') c.cancelados++; });
      return c;
    }
    function setCounters(c){ kpi.total.textContent=c.total; kpi.ab.textContent=c.abiertos; kpi.pr.textContent=c.en_proceso; kpi.ce.textContent=c.cerrados; kpi.ca.textContent=c.cancelados; }

    function currentRows(){
      const base = Array.isArray(ticketsRemote) ? ticketsRemote : ticketsLocal;
      lastSource = Array.isArray(ticketsRemote) ? 'Sheets' : 'Local';
      let rows = base.slice();

      const st = statusSelect.value;
      if (st==='pendientes') rows = rows.filter(x => !['Cerrado','Cancelado'].includes(String(x.estado)));
      else if (st) rows = rows.filter(x => String(x.estado)===st);

      const ana = analystSelect.value;
      if (viewSelect.value==='mis' && identity?.name){
        rows = rows.filter(x => String(x.analista)===identity.name);
      } else if (ana){ rows = rows.filter(x => String(x.analista)===ana); }

      const ym = monthSelect.value;
      if (ym){
        rows = rows.filter(x=>{
          const d = new Date(x.fecha);
          const y2 = d.getFullYear(), m2 = String(d.getMonth()+1).padStart(2,'0');
          return `${y2}-${m2}`===ym;
        });
      }

      // Buscador de la izquierda
      const q = norm(qSearch.value);
      if (q){
        rows = rows.filter(t =>
          norm(t.id).includes(q) ||
          norm(t.categoria).includes(q) ||
          norm(t.falla).includes(q) ||
          norm(t.usuario).includes(q)
        );
      }

      rows.sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
      return rows;
    }

    function render(countersFromAPI){
      const rows = currentRows();
      if (countersFromAPI && lastSource==='Sheets') setCounters(countersFromAPI);
      else setCounters(computeCounters(rows));

      syncBadge.innerHTML = `Fuente: <strong>${lastSource}</strong>`;

      tbody.innerHTML = rows.map(t=>`
        <tr>
          <td>${t.id||''}</td>
          <td>${esc(t.analista||'')}</td>
          <td>${esc(t.categoria||'')}</td>
          <td>${esc(t.falla||'')}</td>
          <td>${esc(t.usuario||'')}</td>
          <td>${badge(t.prioridad||'')}</td>
          <td>${tagE(t.estado||'')}</td>
          <td>${fmt(t.fecha)}</td>
          <td>${esc(t.motivo||'')}</td>
          <td style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <select class="estado-select" data-id="${t.id}">
              <option ${t.estado==='Abierto'?'selected':''}>Abierto</option>
              <option ${t.estado==='En Proceso'?'selected':''}>En Proceso</option>
              <option ${t.estado==='Cerrado'?'selected':''}>Cerrado</option>
              <option ${t.estado==='Cancelado'?'selected':''}>Cancelado</option>
            </select>
            <select class="prio-select" data-id="${t.id}">
              <option ${t.prioridad==='Alta'?'selected':''}>Alta</option>
              <option ${t.prioridad==='Media'?'selected':''}>Media</option>
              <option ${t.prioridad==='Baja'?'selected':''}>Baja</option>
            </select>
          </td>
        </tr>`).join('') || `<tr><td colspan="10" style="text-align:center;color:#51608b">Sin resultados</td></tr>`;
    }

    /* =========================================================
       WHOAMI + LIST (autenticación)
       ========================================================= */
    async function fetchWhoAmI(){
      try{
        const params = new URLSearchParams({ action:'whoami' });
        if (AUTH_KEY) params.set('key', AUTH_KEY); // clave opcional para pruebas fuera del dominio
        const res = await fetch(WEB_APP_URL + '?' + params.toString());
        const data = await res.json();
        identity = data && data.ok ? data.me : null;
        who.textContent = identity ? `Identidad: ${identity.name} (${identity.role})` : 'Identidad: (no detectada)';
        const isAdmin = identity && identity.role==='admin';
        viewSelect.disabled = !isAdmin; if (!isAdmin) viewSelect.value='mis';
        if (identity && !$('#analystSelect').value) $('#analystSelect').value = identity.name;
      }catch{ identity = null; who.textContent = 'Identidad: (no detectada)'; }
    }

    async function fetchRemote(){
      try{
        const params = new URLSearchParams();
        params.set('action','list');
        params.set('view', viewSelect.value);
        if (analystSelect.value) params.set('analyst', analystSelect.value);
        if (statusSelect.value==='pendientes') params.set('state','pendientes');
        else if (statusSelect.value) params.set('status', statusSelect.value);
        if (monthSelect.value) params.set('ym', monthSelect.value);
        params.set('limit','1500');
        if (AUTH_KEY) params.set('key', AUTH_KEY);

        const res = await fetch(WEB_APP_URL + '?' + params.toString());
        const data = await res.json();
        if (data && data.ok){
          ticketsRemote = Array.isArray(data.items) ? data.items : [];
          if (data.me){ identity = data.me; who.textContent = `Identidad: ${identity.name} (${identity.role})`; }
          render(data.counters);
        } else { ticketsRemote = null; render(); }
      }catch{ ticketsRemote = null; render(); }
    }

    /* =========================================================
       POST
       ========================================================= */
    async function postJSON(payload){
      if (AUTH_KEY) payload.key = AUTH_KEY;
      const res = await fetch(WEB_APP_URL, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
      try { return await res.json(); } catch { return { ok:false, error:'Respuesta no-JSON' }; }
    }

    /* =========================================================
       CREAR TICKET
       ========================================================= */
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const analista = $('#analista').value;
      const correoAnalista = $('#correoAnalista').value.trim();
      const categoria = $('#categoria').value;
      const falla = $('#falla').value;
      const usuario = $('#usuario').value.trim();
      const prioridad = $('#prioridad').value;
      const descripcion = $('#descripcion').value.trim(); // opcional
      const adjInput = $('#adj'); const adjuntoNombre = adjInput.files?.[0]?.name || '';

      if(!analista || !categoria || !falla || !usuario || !prioridad){
        show('Completa los campos obligatorios','err'); return;
      }

      const id = 'T' + new Date().toISOString().replace(/\D/g,'').slice(0,14);
      const nowISO = new Date().toISOString();
      const t = { id, analista, correoAnalista, categoria, falla, usuario, prioridad, descripcion, adjuntoNombre, estado:'Abierto', fecha: nowISO };

      ticketsLocal.unshift(t); saveLocal(ticketsLocal); render(); show('Guardado local. Enviando a Sheets…');
      const d = await postJSON({ action:'create', id:t.id, analista, correoAnalista, categoria, falla, usuario, prioridad, descripcion, estado:t.estado, fechaISO: nowISO, adjuntoNombre });
      if (!d || !d.ok){ show('No se pudo crear en Sheets', 'err'); } else { fetchRemote(); }
      form.reset(); $('#correoAnalista').value='';
    });

    /* =========================================================
       CAMBIOS EN ESTADO / PRIORIDAD
       ========================================================= */
    document.addEventListener('change', async (e)=>{
      const selE = e.target.closest('.estado-select');
      const selP = e.target.closest('.prio-select');

      if (selE){
        const id = selE.dataset.id; const status = selE.value;
        let reason = ''; if (status === 'Cancelado') reason = prompt('Motivo de cancelación:') || '';
        const tL = ticketsLocal.find(x=>x.id===id);
        if (tL){ tL.estado=status; tL.fecha=new Date().toISOString(); if(status==='Cancelado') tL.motivo=reason; saveLocal(ticketsLocal); }
        render();
        const d = await postJSON({ action:'update_status', id, status, reason });
        if (d && d.ok) fetchRemote();
      }

      if (selP){
        const id = selP.dataset.id; const pr = selP.value;
        const tL = ticketsLocal.find(x=>x.id===id);
        if (tL){ tL.prioridad=pr; tL.fecha=new Date().toISOString(); saveLocal(ticketsLocal); }
        render();
        const d2 = await postJSON({ action:'update_priority', id, prioridad: pr });
        if (d2 && d2.ok) fetchRemote();
      }
    });

    /* =========================================================
       BUSCADOR (izquierda) + ACCESOS RÁPIDOS
       ========================================================= */
    qSearch.addEventListener('input', ()=> render());
    document.querySelectorAll('.chipbtn[data-prio]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ $('#prioridad').value = btn.dataset.prio; });
    });
    document.querySelectorAll('.chipbtn.tpl').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const t = $('#descripcion'); t.value = btn.dataset.text; t.focus();
      });
    });

    /* =========================================================
       INIT
       ========================================================= */
    async function init(){
      await fetchWhoAmI();
      render();               // render rápido local
      fetchRemote();          // cuando llegue Sheets, reemplaza
      setInterval(()=>{ if(!document.hidden) fetchRemote(); }, AUTO_REFRESH_MS);
    }
    init();
  })();
  </script>
</body>
</html>

