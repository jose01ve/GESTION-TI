/***** CONFIG *****/
const SHEET_NAME_CANDIDATES = ['Reporte TI','ReporteTI']; // ajusta si usas otro
const COL = { ID:1, TITULO:2, CATEGORIA:3, PRIORIDAD:4, REPOR:5, CORREO:6, DESC:7, ESTADO:8, FECHA:9, ADJ:10 };

/***** CORE *****/
function getSheet(){
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  for (const n of SHEET_NAME_CANDIDATES){
    const sh = ss.getSheetByName(n);
    if (sh) return sh;
  }
  return ss.getSheets()[0]; // fallback
}

function doPost(e){
  const out = o => ContentService.createTextOutput(JSON.stringify(o))
                    .setMimeType(ContentService.MimeType.JSON);
  let data = {};
  try { data = JSON.parse(e.postData.contents || '{}'); }
  catch { return out({ ok:false, error:'JSON inválido' }); }

  const lock = LockService.getScriptLock();
  lock.tryLock(30000);
  try {
    const action = String(data.action||'').toLowerCase();
    if (action === 'create')        return out(createTicket(data));
    if (action === 'update_status') return out(updateStatus(data));
    if (action === 'delete')        return out(deleteTicket(data));
    return out({ ok:false, error:'Acción no soportada' });
  } finally {
    if (lock.hasLock()) lock.releaseLock();
  }
}

function findRowById(sh, id){
  if (!id) return -1;
  const last = sh.getLastRow();
  if (last < 2) return -1;
  const ids = sh.getRange(2, COL.ID, last-1, 1).getValues().flat();
  const i = ids.findIndex(v => String(v).trim() === String(id).trim());
  return i === -1 ? -1 : i + 2; // +2 por encabezado y base 1
}

function createTicket(d){
  const sh   = getSheet();
  const when = d.fechaISO ? new Date(d.fechaISO) : new Date();
  const row0 = findRowById(sh, d.id);
  const values = [
    d.id||'', d.titulo||'', d.categoria||'', d.prioridad||'',
    d.reportadoPor||'', d.correo||'', d.descripcion||'',
    d.estado||'Abierto', when, d.adjuntoNombre||''
  ];
  const row = row0 > 0 ? row0 : sh.getLastRow() + 1;
  sh.getRange(row, 1, 1, values.length).setValues([values]);
  return { ok:true, row };
}

function updateStatus(d){
  const sh = getSheet();
  let row = Number(d.row)||0;

  // si mandas 'row', validamos que el ID coincida
  if (row > 1) {
    const idAtRow = sh.getRange(row, COL.ID).getValue();
    if (String(idAtRow).trim() !== String(d.id).trim()) row = 0;
  }
  if (row < 2) row = findRowById(sh, d.id);
  if (row < 2) return { ok:false, error:'ID no encontrado' };

  sh.getRange(row, COL.ESTADO).setValue(d.status||'Abierto');
  sh.getRange(row, COL.FECHA).setValue(new Date());
  return { ok:true, row };
}

function deleteTicket(d){
  const sh = getSheet();
  const row = findRowById(sh, d.id);
  if (row < 2) return { ok:false, error:'ID no encontrado' };
  sh.deleteRow(row);
  return { ok:true };
}

/* OPCIONAL: ejecutar 1 vez para limpiar duplicados por ID */
function dedupeById(){
  const sh = getSheet();
  const last = sh.getLastRow();
  if (last < 3) return;
  const ids = sh.getRange(2, COL.ID, last-1, 1).getValues().flat();
  const seen = new Set();
  for (let i = ids.length; i >= 1; i--){
    const id = String(ids[i-1]||'').trim();
    if (!id) continue;
    if (seen.has(id)) sh.deleteRow(i+1);
    else seen.add(id);
  }
}
