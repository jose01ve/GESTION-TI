<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión TI · Reporte de fallas</title>

  <style>
    /* ========= 00) CONTENEDOR FLUIDO ========= */
    :root{
      /* Ancho máximo “inteligente”: ocupa el 96% del viewport hasta 1600px */
      --container: min(1600px, 96vw);
      --accent:#6475ff;
      --bg:#eef2ff; --card:#ffffff; --text:#0d1333; --muted:#51608b;
      --border:rgba(13,19,51,.12); --field:#fbfcff;
    }
    body[data-theme="dark"]{ --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9aa4bf; --border:rgba(255,255,255,.15); --field:#0b1220 }
    body[data-theme="mint"]{ --bg:#e6fff4; --card:#ffffff; --text:#0d1333; --muted:#4d6a61; --border:rgba(13,19,51,.12); --field:#f7fffb }
    body[data-theme="blue"]{ --bg:#e7f3ff; --card:#ffffff; --text:#0f1a2b; --muted:#3c587a; --border:rgba(15,26,43,.12); --field:#f7fbff }
    body[data-theme="navy"]{ --bg:#0b1629; --card:#0f2038; --text:#ebf1ff; --muted:#9fb3d1; --border:rgba(255,255,255,.14); --field:#0c1b30 }

    /* ========= 02) BASE ========= */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif }

    /* ========= 03) TOPBAR ========= */
    header{position:sticky; top:0; z-index:20; padding:6px 0}
    .toprow{ width:var(--container); margin:0 auto; padding:0 8px; display:flex; align-items:center; gap:10px; justify-content:flex-end }
    .ctl,.btn-sm{ height:36px; padding:6px 10px; border:1px solid var(--border); border-radius:10px; background:var(--field); color:var(--text) }
    .btn-sm{ background:var(--card); cursor:pointer }
    .btn-sm.accent{ background:var(--accent); border-color:var(--accent); color:#fff }
    #themePick{ width:180px }

    /* ========= 04) LOGO ========= */
    .logoWrap{ width:var(--container); margin:0 auto; padding:0 8px 8px; display:flex; justify-content:flex-start }
    .logo{ height:clamp(84px, 9vh, 120px); opacity:.92; mix-blend-mode:multiply; filter:saturate(.9) contrast(1.06) brightness(1.03) }

    /* ========= 05) LAYOUT ========= */
    :root{ --stickyTop:58px }
    main{ width:var(--container); margin:4px auto 12px; padding:0 8px; display:grid; gap:16px }
    @media(min-width:1200px){ main{ grid-template-columns:640px 1fr } }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 24px rgba(13,19,51,.08) }
    .card h2{ position:sticky; top:0; z-index:2; margin:0; padding:12px 16px; background:linear-gradient(180deg,color-mix(in srgb,var(--card) 98%,transparent), color-mix(in srgb,var(--card) 92%,transparent)); border-bottom:1px solid var(--border) }
    .card .body{ padding:16px }
    #cardForm{ position:sticky; top:var(--stickyTop); align-self:start; max-height:calc(100vh - var(--stickyTop) - 8px); overflow:auto }

    /* ========= 06) FORMULARIO ========= */
    form .grid{ display:grid; gap:12px }
    @media(min-width:560px){ form .grid{ grid-template-columns:1fr 1fr } }
    label{ font-size:.9rem; color:var(--muted); display:block; margin-bottom:6px }
    input,select,textarea{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--field); color:var(--text) }
    textarea{ min-height:96px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
    .btn{ border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer }
    .btn.accent{ background:var(--accent); color:#fff; border-color:var(--accent); box-shadow:0 8px 16px color-mix(in srgb,var(--accent) 25%, transparent) }
    .btn.secondary{ background:color-mix(in srgb,var(--accent) 10%, var(--card)); border-color:color-mix(in srgb,var(--accent) 30%, var(--border)) }
    .btn.secondary:hover{ background:color-mix(in srgb,var(--accent) 14%, var(--card)) }

    .mini{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px }
    .mini h3{ margin:0 0 8px 0; font-size:1rem }
    .mini ul{ margin:0 0 0 18px; padding:0 }
    .mini .dot{ font-weight:700; margin-right:6px }

    details.snippets summary{ cursor:pointer; user-select:none; color:var(--muted); padding:8px 0; font-weight:600 }
    .snippet-btn{ border:1px dashed var(--border); background:color-mix(in srgb,var(--accent) 8%, var(--card)); border-radius:10px; padding:8px 10px; cursor:pointer }
    .snippet-btn:hover{ background:color-mix(in srgb,var(--accent) 12%, var(--card)) }

    /* ========= 07) KPIs y TABLA ========= */
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0 12px }
    .toolbar select{ padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:var(--field) }
    .muted{ color:var(--muted); font-size:.9rem }
    .kpis{ display:grid; grid-template-columns:repeat(6,minmax(160px,1fr)); gap:12px; margin-bottom:8px }
    .kpi{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px }
    .kpi .label{ font-size:.88rem; color:var(--muted); white-space:nowrap }
    .kpi .val{ font-weight:800; font-size:1.25rem }

    .tablebox{ overflow:auto; max-height: calc(100vh - 320px) }
    table{ width:100%; border-collapse:separate; border-spacing:0 10px; color:var(--text) }
    thead th{ position:sticky; top:0; z-index:1; font-size:.86rem; color:var(--muted); text-align:left; padding:0 8px; white-space:nowrap; background: color-mix(in srgb, var(--card) 92%, transparent) }
    tbody tr{ background:var(--card); border:1px solid var(--border) }
    tbody td{ padding:10px 8px; vertical-align:top }
    tbody tr:hover{ box-shadow:0 0 0 2px color-mix(in srgb,var(--accent) 18%, transparent) inset }
    .badge{ padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:.78rem; white-space:nowrap }
    .prio-alta{ background:#fff5f5 } .prio-media{ background:#fff4e6 } .prio-baja{ background:#ebfbee }
    body[data-theme="dark"] .prio-alta{ background:#402b2b } body[data-theme="dark"] .prio-media{ background:#3e2f18 } body[data-theme="dark"] .prio-baja{ background:#1b3b2a }
    .e-abierto{ color:#e03131 } .e-proceso{ color:#f08c00 } .e-cerrado{ color:#2b8a3e } .e-cancelado{ color:#6b7280 }

    /* ===== Acciones legibles (ancho fijo y texto completo) ===== */
    .actions-cell{ min-width: 280px; }
    .estado-select, .prio-select{
      min-width: 130px;  /* << suficiente para “En Proceso” */
      font-size: .9rem;
      padding: 8px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--field);
      color:var(--text);
      white-space: nowrap;
    }
    .actions-stack{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center
    }

    /* ========= 08) AUTOCOMPLETE ========= */
    .ac{ position:relative }
    .ac-list{ position:absolute; left:0; right:0; top:100%; background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:0 10px 24px rgba(13,19,51,.08); margin-top:6px; max-height:220px; overflow:auto; padding:6px; z-index:5 }
    .ac-list[hidden]{ display:none }
    .ac-list li{ list-style:none; padding:8px 12px; cursor:pointer; border-radius:10px }
    .ac-list li[aria-selected="true"], .ac-list li:hover{ background:color-mix(in srgb,var(--accent) 10%, transparent) }

    .notice{ display:none; margin-top:10px; padding:10px 12px; border:1px solid var(--border); border-radius:10px }
    footer{ width:var(--container); margin:6px auto 28px; padding:0 8px; color:var(--muted); font-size:.9rem }

    /* ========= 09) MODAL ========= */
    dialog.modal{
      width:min(560px, 92vw);
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--card);
      color:var(--text);
      padding:0;
    }
    dialog::backdrop{ background:rgba(0,0,0,.35); backdrop-filter:saturate(110%) blur(3px) }
    .modal header{ padding:14px 16px; border-bottom:1px solid var(--border) }
    .modal .content{ padding:16px }
    .modal footer{ padding:12px 16px; display:flex; gap:10px; justify-content:flex-end }
    .modal textarea{ min-height:120px }
    .desc-peek{ cursor:pointer; text-decoration:underline; text-underline-offset:2px; }
  </style>
</head>
<body data-theme="light">
  <!-- ====== Barra superior (SIN “Identidad”) ====== -->
  <header>
    <div class="toprow">
      <!-- Clave opcional (la identidad ya no se muestra) -->
      <input id="keyInput" class="ctl" placeholder="Clave (opcional)" style="width:160px">
      <button id="saveKey" class="btn-sm accent">Guardar</button>
      <button id="clearKey" class="btn-sm" title="Olvidar">✕</button>

      <!-- Selector de tema base + acento por HEX -->
      <select id="themePick" class="ctl" title="Tema">
        <optgroup label="Tema base">
          <option value="Claro"        data-theme="light">Tema: Claro (verde)</option>
          <option value="Oscuro"       data-theme="dark">Tema: Oscuro</option>
          <option value="Mint"         data-theme="mint">Tema: Mint</option>
          <option value="Azul"         data-theme="blue">Tema: Azul</option>
          <option value="Azul oscuro"  data-theme="navy">Tema: Azul oscuro</option>
        </optgroup>
        <optgroup label="Color de acento (HEX)">
          <option value="Verde"        data-hex="#92e87c">Acento: Verde</option>
          <option value="Amarillo"     data-hex="#ffe764">Acento: Amarillo</option>
          <option value="Rojo"         data-hex="#e74176">Acento: Rojo</option>
          <option value="Azul"         data-hex="#0040a8">Acento: Azul</option>
          <option value="Azul claro"   data-hex="#20a1d8">Acento: Azul claro</option>
          <option value="Azul oscuro"  data-hex="#003f84">Acento: Azul oscuro</option>
        </optgroup>
      </select>
    </div>
  </header>

  <!-- ====== Logo ====== -->
  <div class="logoWrap">
    <img class="logo" src="Imagen/logo-empresas.jpg" alt="INGETEC / SEDIC · Proyecto Hidroeléctrico Ituango"
         loading="lazy" onerror="this.onerror=null;this.src='https://jose01ve.github.io/GESTION-TI/Imagen/logo-empresas.jpg';">
  </div>

  <main>
    <!-- ===================== REPORTE USUARIO ===================== -->
    <section id="cardForm" class="card">
      <h2>REPORTE USUARIO</h2>
      <div class="body">
        <!-- … (tu formulario se mantiene igual) … -->
        <!-- Para ahorrar espacio, no se repite: pega aquí el mismo bloque de FORM que ya usas -->
        <!-- Nada del form fue cambiado por este ajuste -->
      </div>
    </section>

    <!-- ===================== ESTADO DE REPORTE ===================== -->
    <section id="cardReport" class="card">
      <h2>ESTADO DE REPORTE</h2>
      <div class="body">
        <div class="toolbar">
          <span class="muted">Vista:</span>
          <select id="viewSelect"><option value="mis">Asignados a mí</option><option value="todos">Todos (admin)</option></select>

          <span class="muted">Analista:</span>
          <select id="analystSelect"><option value="">Todos</option><option>Jose Salas</option><option>Sebastián Cataño</option><option>Sebastián Posada</option><option>Pablo Calle</option></select>

          <span class="muted">Estado:</span>
          <select id="statusSelect"><option value="">Todos</option><option value="pendientes">Pendientes</option><option value="Abierto">Abierto</option><option value="En Proceso">En Proceso</option><option value="Cerrado">Cerrado</option><option value="Cancelado">Cancelado</option></select>

          <span class="muted">Mes:</span>
          <select id="monthSelect"><option value="">Todos</option></select>

          <span id="syncBadge" class="muted">Fuente: —</span>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="label">Total</div><div class="val" id="kpiTotal">0</div></div>
          <div class="kpi"><div class="label">Abiertos</div><div class="val" id="kpiAb">0</div></div>
          <div class="kpi"><div class="label">En proceso</div><div class="val" id="kpiPr">0</div></div>
          <div class="kpi"><div class="label">Cerrados</div><div class="val" id="kpiCe">0</div></div>
          <div class="kpi"><div class="label">Cancelados</div><div class="val" id="kpiCa">0</div></div>
          <div class="kpi"><div class="label">Con requerimiento</div><div class="val" id="kpiRq">0</div></div>
        </div>

        <div class="tablebox">
          <table>
            <thead>
              <tr>
                <th>Ticket</th><th>Analista</th><th>Categoría</th><th>Falla</th><th>Usuario</th>
                <th>Descripción</th>
                <th>Prioridad</th><th>Estado</th><th>Fecha</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- ========= MODAL ========= -->
  <dialog id="statusModal" class="modal">
    <header><h3 id="modalTitle" style="margin:0">Actualizar estado</h3></header>
    <div class="content">
      <label id="modalLabel" for="modalText" style="display:block; color:var(--muted); margin-bottom:6px">Detalle</label>
      <textarea id="modalText" class="ctl" style="width:100%"></textarea>
    </div>
    <footer>
      <button id="modalCancel" class="btn">Cancelar</button>
      <button id="modalOk" class="btn accent">Aceptar</button>
    </footer>
  </dialog>

  <footer>⚡ App HTML sincroniza con Google Sheets. Eliminación deshabilitada; usar estado “Cancelado”.</footer>

  <script>
  (function(){
    'use strict';

    /* ==================== CONFIG ==================== */
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwWF0rbBu4l3FJkhXJS9oMsL5SSaQ7uwMeTg8abHL2mMmYyvdTEYT2Ef79QHVAEtzhfsQ/exec';   // ← pon la tuya
    const AUTO_REFRESH_MS = 30000;

    /* ==================== DOM ==================== */
    const $ = s => document.querySelector(s);
    const tbody = $('#tbody'),
          kpiTotal=$('#kpiTotal'), kpiAb=$('#kpiAb'), kpiPr=$('#kpiPr'), kpiCe=$('#kpiCe'), kpiCa=$('#kpiCa'), kpiRq=$('#kpiRq');
    const viewSelect = $('#viewSelect'), analystSelect = $('#analystSelect'),
          statusSelect = $('#statusSelect'), monthSelect  = $('#monthSelect'),
          quickSearch = $('#quickSearch'), themePick = $('#themePick');
    const syncBadge = $('#syncBadge');

    /* Modal reutilizable */
    const modal = $('#statusModal'), modalTitle = $('#modalTitle'),
          modalLabel = $('#modalLabel'), modalText = $('#modalText'),
          modalOk = $('#modalOk'), modalCancel = $('#modalCancel');

    /* ==================== STATE ==================== */
    const localKey = 'tickets_fallas_v12';
    const loadLocal = () => { try{ return JSON.parse(localStorage.getItem(localKey))||[] } catch { return [] } };
    const saveLocal = v => localStorage.setItem(localKey, JSON.stringify(v));
    let ticketsLocal = loadLocal();
    let ticketsRemote = null;
    let lastSource = 'Local';
    let identity = null;   // seguimos usando identidad internamente (no se muestra)
    let AUTH_KEY = '';
    let searchText = '';

    /* ==================== CLAVE OPCIONAL (sin texto de identidad) ==================== */
    const keyInput = $('#keyInput'), saveKeyBtn = $('#saveKey'), clearKeyBtn = $('#clearKey');
    (function initKey(){
      const urlKey = new URLSearchParams(location.search).get('key') || '';
      const stored = localStorage.getItem('auth_key') || '';
      AUTH_KEY = urlKey || stored || '';
      if (urlKey && urlKey !== stored) localStorage.setItem('auth_key', urlKey);
      keyInput.value = AUTH_KEY;
    })();
    saveKeyBtn.addEventListener('click', ()=>{ AUTH_KEY = keyInput.value.trim(); localStorage.setItem('auth_key', AUTH_KEY); fetchWhoAmI().then(fetchRemote); });
    clearKeyBtn.addEventListener('click', ()=>{ AUTH_KEY=''; keyInput.value=''; localStorage.removeItem('auth_key'); fetchWhoAmI().then(fetchRemote); });

    /* ==================== TEMA ==================== */
    function applyBaseTheme(theme){ document.body.setAttribute('data-theme', theme); localStorage.setItem('ui_theme', theme); }
    function applyAccent(hex){ document.documentElement.style.setProperty('--accent', hex); localStorage.setItem('ui_accent_hex', hex); }
    (function initTheme(){
      const savedTheme = localStorage.getItem('ui_theme') || 'light';
      const savedAccent = localStorage.getItem('ui_accent_hex') || '#6475ff';
      applyBaseTheme(savedTheme); applyAccent(savedAccent);
      themePick?.addEventListener('change', ()=>{
        const opt = themePick.selectedOptions[0];
        const theme = opt.dataset.theme;
        const hex   = opt.dataset.hex;
        if (theme) applyBaseTheme(theme);
        if (hex)   applyAccent(hex);
      });
    })();

    /* ==================== HELPERS ==================== */
    const esc = s => String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
    const trunc = (s,len=30)=>{ const t=String(s||''); return t.length>len ? t.slice(0,len)+'…' : t; };
    const badge = p => `<span class="badge ${p==='Alta'?'prio-alta':p==='Media'?'prio-media':'prio-baja'}">${p||''}</span>`;
    const tagE  = e => { const s = String(e||''); const cls = (s==='Abierto')?'e-abierto':(s==='En Proceso')?'e-proceso':(s==='Cerrado')?'e-cerrado':'e-cancelado'; return `<strong class="${cls}">${s}</strong>`; };
    const fmt = iso => { const d = (iso instanceof Date) ? iso : new Date(iso); return isNaN(d) ? '' : d.toLocaleString(); };

    function computeCounters(rows){
      const c = { total:rows.length, abiertos:0, en_proceso:0, cerrados:0, cancelados:0, con_req:0 };
      rows.forEach(t=>{
        const s=String(t.estado||'').toLowerCase();
        if(s==='abierto') c.abiertos++; else if(s==='en proceso') c.en_proceso++; else if(s==='cerrado') c.cerrados++; else if(s==='cancelado') c.cancelados++;
        if (t.requerimiento) c.con_req++;
      });
      return c;
    }
    function setCounters(c){ kpiTotal.textContent=c.total; kpiAb.textContent=c.abiertos; kpiPr.textContent=c.en_proceso; kpiCe.textContent=c.cerrados; kpiCa.textContent=c.cancelados; kpiRq.textContent=c.con_req||0; }

    function currentRows(){
      const base = Array.isArray(ticketsRemote) ? ticketsRemote : ticketsLocal;
      lastSource = Array.isArray(ticketsRemote) ? 'Sheets' : 'Local';
      let rows = base.slice();

      // filtros…
      const st = $('#statusSelect').value;
      const an = $('#analystSelect').value;
      const ym = $('#monthSelect').value;
      if (st==='pendientes'){ rows = rows.filter(x => !['Cerrado','Cancelado'].includes(String(x.estado))); }
      else if (st) rows = rows.filter(x => String(x.estado)===st);
      if (an) rows = rows.filter(x => String(x.analista)===an);
      if (ym){
        rows = rows.filter(x => {
          const d = new Date(x.fecha);
          const y2 = d.getFullYear(), m2 = String(d.getMonth()+1).padStart(2,'0');
          return `${y2}-${m2}` === ym;
        });
      }

      if (searchText && searchText.trim()){
        const n = searchText.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        rows = rows.filter(r =>
          (`${r.id} ${r.categoria} ${r.falla} ${r.usuario} ${r.descripcion||''}`).toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
            .includes(n)
        );
      }
      rows.sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
      return rows;
    }

    /* ========= Render con “Acciones” legibles ========= */
    function render(countersFromAPI){
      const rows = currentRows();
      if (countersFromAPI && lastSource==='Sheets') setCounters(countersFromAPI);
      else setCounters(computeCounters(rows));

      syncBadge.innerHTML = `Fuente: <strong>${lastSource}</strong>`;

      $('#tbody').innerHTML = rows.length ? rows.map(t=>`
        <tr>
          <td>${t.id||''}</td>
          <td>${esc(t.analista||'')}</td>
          <td>${esc(t.categoria||'')}</td>
          <td>${esc(t.falla||'')}</td>
          <td>${esc(t.usuario||'')}</td>
          <td>${t.descripcion
              ? `<span class="desc-peek" data-id="${t.id}" data-full="${esc(t.descripcion)}" title="Ver descripción completa">${esc(trunc(t.descripcion,30))}</span>`
              : '<span class="muted">—</span>'}
          </td>
          <td>${badge(t.prioridad||'')}</td>
          <td>${tagE(t.estado||'')}</td>
          <td>${fmt(t.fecha)}</td>

          <td class="actions-cell">
            <div class="actions-stack">
              <select class="estado-select" data-id="${t.id}">
                <option ${t.estado==='Abierto'?'selected':''}>Abierto</option>
                <option ${t.estado==='En Proceso'?'selected':''}>En Proceso</option>
                <option ${t.estado==='Cerrado'?'selected':''}>Cerrado</option>
                <option ${t.estado==='Cancelado'?'selected':''}>Cancelado</option>
              </select>
              <select class="prio-select" data-id="${t.id}">
                <option ${t.prioridad==='Alta'?'selected':''}>Alta</option>
                <option ${t.prioridad==='Media'?'selected':''}>Media</option>
                <option ${t.prioridad==='Baja'?'selected':''}>Baja</option>
              </select>
            </div>
          </td>
        </tr>`).join('') : `<tr><td colspan="10" style="text-align:center;color:#51608b">Sin resultados</td></tr>`;
    }

    /* ==================== WHOAMI (silencioso, sin mostrar texto) ==================== */
    async function fetchWhoAmI(){
      try{
        const params = new URLSearchParams({ action:'whoami' });
        if (AUTH_KEY) params.set('key', AUTH_KEY);
        const res = await fetch(WEB_APP_URL + '?' + params.toString());
        const data = await res.json();
        identity = data && data.ok ? data.me : null;
        const isAdmin = identity && identity.role==='admin';
        $('#viewSelect').disabled = !isAdmin; if (!isAdmin) $('#viewSelect').value = 'mis';
      }catch{ identity = null; }
    }

    /* ==================== FETCH LIST ==================== */
    async function fetchRemote(){
      try{
        const params = new URLSearchParams();
        params.set('action','list');
        params.set('view', $('#viewSelect').value);
        if ($('#analystSelect').value) params.set('analyst', $('#analystSelect').value);
        if ($('#statusSelect').value==='pendientes') params.set('state','pendientes');
        else if ($('#statusSelect').value) params.set('status', $('#statusSelect').value);
        if ($('#monthSelect').value) params.set('ym', $('#monthSelect').value);
        params.set('limit','1500');
        if (AUTH_KEY) params.set('key', AUTH_KEY);
        const res = await fetch(WEB_APP_URL + '?' + params.toString());
        const data = await res.json();
        if (data && data.ok && Array.isArray(data.items)){
          ticketsRemote = data.items; render(data.counters);
        } else { ticketsRemote = null; render(); }
      }catch{ ticketsRemote = null; render(); }
    }

    /* ==================== CAMBIOS ESTADO / PRIORIDAD ==================== */
    document.addEventListener('focusin',(e)=>{
      const s = e.target.closest('.estado-select');
      if (s) s.dataset.prev = s.value;
    });

    function askModal({title,label,placeholder='', required=false, readonly=false, okText='Aceptar', prefill='' }){
      return new Promise(resolve=>{
        modalTitle.textContent = title;
        modalLabel.textContent = label;
        modalText.placeholder = placeholder || '';
        modalText.required = required; modalText.readOnly = !!readonly;
        modalOk.textContent = okText; modalText.value = prefill || '';
        const onOk = ()=>{ if(required && !modalText.value.trim()){ modalText.focus(); return; } cleanup(); modal.close(); resolve({ok:true, text: modalText.value.trim()}); };
        const onCancel = ()=>{ cleanup(); modal.close(); resolve({ok:false}); };
        function cleanup(){ modalOk.removeEventListener('click', onOk); modalCancel.removeEventListener('click', onCancel); modal.removeEventListener('cancel', onCancel); }
        modalOk.addEventListener('click', onOk); modalCancel.addEventListener('click', onCancel); modal.addEventListener('cancel', onCancel);
        modal.showModal(); setTimeout(()=>modalText.focus(), 50);
      });
    }

    document.addEventListener('click', (e)=>{
      const peek = e.target.closest('.desc-peek');
      if (!peek) return;
      askModal({ title:'Descripción completa', label:'Descripción', readonly:true, okText:'Cerrar', prefill: peek.dataset.full || '' });
    });

    document.addEventListener('change', async (e)=>{
      const selE = e.target.closest('.estado-select');
      const selP = e.target.closest('.prio-select');

      async function postJSON(payload){
        if (AUTH_KEY) payload.key = AUTH_KEY;
        const res = await fetch(WEB_APP_URL, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
        try { return await res.json(); } catch { return { ok:false }; }
      }

      if (selE){
        const id = selE.dataset.id;
        const newStatus = selE.value;
        const prev = selE.dataset.prev || 'Abierto';

        if (newStatus === 'Cancelado'){
          const r = await askModal({title:'Cancelar ticket', label:'Motivo de cancelación', placeholder:'Describe el motivo…', required:true});
          if (!r.ok){ selE.value = prev; return; }
          const d = await postJSON({ action:'update_status', id, status:newStatus, reason:r.text });
          if (d && d.ok) fetchRemote(); else selE.value = prev;
          return;
        }
        if (newStatus === 'Cerrado'){
          const r = await askModal({title:'Cerrar ticket', label:'Solución aplicada', placeholder:'Describe la solución…', required:true});
          if (!r.ok){ selE.value = prev; return; }
          const d = await postJSON({ action:'update_status', id, status:newStatus, solution:r.text });
          if (d && d.ok) fetchRemote(); else selE.value = prev;
          return;
        }
        const d2 = await postJSON({ action:'update_status', id, status:newStatus });
        if (d2 && d2.ok) fetchRemote(); else selE.value = prev;
      }

      if (selP){
        const id = selP.dataset.id; const pr = selP.value;
        const res = await fetch(WEB_APP_URL, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify({ action:'update_priority', id, prioridad: pr, key: AUTH_KEY || undefined }) });
        try{ await res.json(); }catch{}
        fetchRemote();
      }
    });

    /* ==================== INIT ==================== */
    async function init(){
      // Popular combo de meses
      (function fillMonths(){
        const now = new Date(); const items = ['<option value="">Todos</option>'];
        for (let i=0;i<12;i++){
          const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
          const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          const label = d.toLocaleDateString('es-CO', { month:'long', year:'numeric' });
          items.push(`<option value="${ym}">${label}</option>`);
        }
        $('#monthSelect').innerHTML = items.join('');
      })();

      await fetchWhoAmI();
      render();
      fetchRemote();
      setInterval(()=>{ if(!document.hidden) fetchRemote(); }, AUTO_REFRESH_MS);
    }
    init();
  })();
  </script>
</body>
</html>
