<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestión TI · Reporte de fallas</title>
<style>
  /* ===== 01) THEME ===== */
  :root{ --accent:#6475ff; --bg:#eef2ff; --card:#fff; --text:#0d1333; --muted:#51608b; --border:rgba(13,19,51,.12); --field:#fbfcff; }
  body[data-theme="dark"]{ --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9aa4bf; --border:rgba(255,255,255,.15); --field:#0b1220 }
  body[data-theme="mint"]{ --bg:#e6fff4; --card:#fff; --text:#0d1333; --muted:#4d6a61; --border:rgba(13,19,51,.12); --field:#f7fffb }
  body[data-theme="blue"]{ --bg:#e7f3ff; --card:#fff; --text:#0f1a2b; --muted:#3c587a; --border:rgba(15,26,43,.12); --field:#f7fbff }
  body[data-theme="navy"]{ --bg:#0b1629; --card:#0f2038; --text:#ebf1ff; --muted:#9fb3d1; --border:rgba(255,255,255,.14); --field:#0c1b30 }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}

  /* ===== 02) TOPBAR ===== */
  header{position:sticky;top:0;z-index:20;padding:4px 0}
  .toprow{max-width:1680px;margin:0 auto;padding:0 16px;display:flex;align-items:center;gap:12px;justify-content:flex-end}
  .chip{font-size:.9rem;color:var(--muted)}
  .ctl,.btn-sm{height:36px;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:var(--field);color:var(--text)}
  .btn-sm{background:var(--card);cursor:pointer}
  .btn-sm.accent{background:var(--accent);border-color:var(--accent);color:#fff}
  #themePick{width:180px}

  /* ===== 03) LAYOUT ===== */
  .logoWrap{max-width:1680px;margin:0 auto;padding:0 16px 6px;display:flex;justify-content:flex-start}
  .logo{height:clamp(84px, 10vh, 120px);opacity:.92;mix-blend-mode:multiply;filter:saturate(.9) contrast(1.06) brightness(1.03)}
  :root{ --stickyTop:58px }
  main{max-width:1680px;margin:4px auto 12px;padding:0 16px;display:grid;gap:16px}
  @media(min-width:1200px){ main{grid-template-columns:640px 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(13,19,51,.08)}
  .card h2{position:sticky;top:0;z-index:2;margin:0;padding:12px 16px;background:linear-gradient(180deg,color-mix(in srgb,var(--card) 98%,transparent), color-mix(in srgb,var(--card) 92%,transparent));border-bottom:1px solid var(--border)}
  .card .body{padding:16px}
  #cardForm{position:sticky;top:var(--stickyTop);align-self:start;max-height:calc(100vh - var(--stickyTop) - 8px);overflow:auto}

  /* ===== 04) FORM ===== */
  form .grid{display:grid;gap:12px}
  @media(min-width:560px){ form .grid{grid-template-columns:1fr 1fr} }
  label{font-size:.9rem;color:var(--muted);display:block;margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--field);color:var(--text)}
  textarea{min-height:96px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.accent{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 8px 16px color-mix(in srgb,var(--accent) 25%, transparent)}
  .btn.secondary{background:color-mix(in srgb,var(--accent) 10%, var(--card));border-color:color-mix(in srgb,var(--accent) 30%, var(--border))}
  .btn.secondary:hover{background:color-mix(in srgb,var(--accent) 14%, var(--card))}
  .mini{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .mini h3{margin:0 0 8px;font-size:1rem}
  .mini .dot{font-weight:700;margin-right:6px}
  details.snippets summary{cursor:pointer;user-select:none;color:var(--muted);padding:8px 0;font-weight:600}
  .snippet-btn{border:1px dashed var(--border);background:color-mix(in srgb,var(--accent) 8%, var(--card));border-radius:10px;padding:8px 10px;cursor:pointer}
  .snippet-btn:hover{background:color-mix(in srgb,var(--accent) 12%, var(--card))}

  /* ===== 05) KPIs & TABLE ===== */
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0 12px}
  .toolbar select{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--field)}
  .muted{color:var(--muted);font-size:.9rem}
  .kpis{display:grid;grid-template-columns:repeat(6,minmax(160px,1fr));gap:12px;margin-bottom:8px}
  .kpi{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .kpi .label{font-size:.88rem;color:var(--muted);white-space:nowrap}
  .kpi .val{font-weight:800;font-size:1.25rem}
  .tablebox{overflow:auto;max-height:calc(100vh - 320px)}
  table{width:100%;border-collapse:separate;border-spacing:0 10px;color:var(--text)}
  thead th{position:sticky;top:0;z-index:1;font-size:.86rem;color:var(--muted);text-align:left;padding:0 8px;white-space:nowrap;background:color-mix(in srgb,var(--card) 92%, transparent)}
  tbody tr{background:var(--card);border:1px solid var(--border)}
  tbody td{padding:10px 8px;vertical-align:top}
  tbody tr:hover{box-shadow:0 0 0 2px color-mix(in srgb,var(--accent) 18%, transparent) inset}
  .badge{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:.78rem;white-space:nowrap}
  .prio-alta{background:#fff5f5}.prio-media{background:#fff4e6}.prio-baja{background:#ebfbee}
  body[data-theme="dark"] .prio-alta{background:#402b2b} body[data-theme="dark"] .prio-media{background:#3e2f18} body[data-theme="dark"] .prio-baja{background:#1b3b2a}
  .e-abierto{color:#e03131}.e-proceso{color:#f08c00}.e-cerrado{color:#2b8a3e}.e-cancelado{color:#6b7280}
  .desc-peek{cursor:pointer;text-decoration:underline;text-underline-offset:2px}

  /* ===== 06) MODAL ===== */
  dialog.modal{width:min(560px,92vw);border:1px solid var(--border);border-radius:16px;background:var(--card);color:var(--text);padding:0}
  dialog::backdrop{background:rgba(0,0,0,.35);backdrop-filter:saturate(110%) blur(3px)}
  .modal header{padding:14px 16px;border-bottom:1px solid var(--border)}
  .modal .content{padding:16px}
  .modal footer{padding:12px 16px;display:flex;gap:10px;justify-content:flex-end}
  .modal textarea{min-height:120px}
  summary{cursor:pointer}
</style>
</head>
<body data-theme="light">
<header>
  <div class="toprow">
    <small id="whoami" class="chip">Identidad: (no detectada)</small>
    <input id="keyInput" class="ctl" placeholder="Clave (opcional)" style="width:160px">
    <button id="saveKey" class="btn-sm accent">Guardar</button>
    <button id="clearKey" class="btn-sm" title="Olvidar">✕</button>

    <select id="themePick" class="ctl" title="Tema">
      <optgroup label="Tema base">
        <option data-theme="light">Tema: Claro (verde)</option>
        <option data-theme="dark">Tema: Oscuro</option>
        <option data-theme="mint">Tema: Mint</option>
        <option data-theme="blue">Tema: Azul</option>
        <option data-theme="navy">Tema: Azul oscuro</option>
      </optgroup>
      <optgroup label="Color de acento (HEX)">
        <option data-hex="#92e87c">Acento: Verde</option>
        <option data-hex="#ffe764">Acento: Amarillo</option>
        <option data-hex="#e74176">Acento: Rojo</option>
        <option data-hex="#0040a8">Acento: Azul</option>
        <option data-hex="#20a1d8">Acento: Azul claro</option>
        <option data-hex="#003f84">Acento: Azul oscuro</option>
      </optgroup>
    </select>
  </div>
</header>

<div class="logoWrap">
  <img class="logo" src="Imagen/logo-empresas.jpg" alt="INGETEC / SEDIC · Proyecto Hidroeléctrico Ituango"
       loading="lazy" onerror="this.onerror=null;this.src='https://jose01ve.github.io/GESTION-TI/Imagen/logo-empresas.jpg';">
</div>

<main>
  <!-- ========== FORM TICKETS ========== -->
  <section id="cardForm" class="card">
    <h2>REPORTE USUARIO</h2>
    <div class="body">
      <form id="formTicket" action="javascript:void(0)" autocomplete="off">
        <div class="grid">
          <div><label for="analista">Analista Responsable *</label><select id="analista" required></select></div>
          <div>
            <label for="categoria">Categoría *</label>
            <select id="categoria" required>
              <option value="">Selecciona…</option>
              <option>Red</option><option>Hardware</option><option>Software</option><option>Asesoría</option><option>Préstamo de activo</option>
              <option>Correo</option><option>Impresión</option><option>Mantenimiento</option><option>Servidores</option><option>Otro</option>
            </select>
          </div>
          <div>
            <label for="falla">Servicio prestado *</label>
            <select id="falla" required>
              <option value="">Selecciona…</option>
              <!-- catálogo (resumido) -->
              <option>Asignar Permiso en servidores \ Retirar permisos</option>
              <option>Soporte a equipos informáticos</option>
              <option>Configuración equipo</option>
              <option>Desbloquear cuenta de red</option>
              <option>Préstamo Video Beam / Préstamo equipo</option>
              <option>Crear acta</option>
              <option>Instalación de software - Desinstalación \ Traslado SW</option>
              <option>Permisos en Unidades compartidas</option>
              <option>Permisos VPN</option>
              <option>Gestión en obra</option>
              <option>Gestión aplicaciones</option>
            </select>
          </div>
          <div class="ac">
            <label for="usuario">Usuario quien reporta *</label>
            <input id="usuario" placeholder="Escribe nombre o apellido" required />
            <ul id="acList" class="ac-list" hidden></ul>
            <small class="help">Escribe y elige entre las sugerencias.</small>
          </div>
          <div>
            <label for="prioridad">Prioridad *</label>
            <select id="prioridad" required>
              <option value="">Selecciona…</option><option>Alta</option><option>Media</option><option>Baja</option>
            </select>
          </div>
          <div>
            <label>¿Tiene requerimiento?</label>
            <div class="row" style="margin-top:0">
              <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="hasReq" value="no" id="reqNo" checked> No</label>
              <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="hasReq" value="si" id="reqSi"> Sí</label>
              <input id="reqNumber" class="ctl" placeholder="Número de requerimiento" style="flex:1;min-width:180px;display:none">
            </div>
            <small class="help">Si eliges “Sí”, debes escribir el número antes de guardar.</small>
          </div>
        </div>

        <div style="margin-top:10px">
          <label for="descripcion">Descripción (opcional)</label>
          <textarea id="descripcion" placeholder="Describe el problema reportado…"></textarea>
          <details class="snippets" open>
            <summary>► Plantillas de descripción</summary>
            <div class="row" style="margin-top:8px">
              <button type="button" class="snippet-btn" data-snippet="Usuario se comunica e informa…">Soporte informático</button>
              <button type="button" class="snippet-btn" data-snippet="El usuario informa no puede imprimir…">Problemas de impresión</button>
              <button type="button" class="snippet-btn" data-snippet="Se requiere instalar/desinstalar el programa…">Instalación/desinstalación de software</button>
            </div>
          </details>
        </div>

        <div id="notice" class="notice"></div>
        <div class="row">
          <button class="btn accent" type="submit">➕ Guardar reporte</button>
          <button class="btn secondary" type="reset">↺ Limpiar</button>
          <input id="quickSearch" class="ctl" style="flex:1; min-width:220px" placeholder="Buscar tickets (ID, categoría, falla, usuario)">
        </div>
      </form>
    </div>
  </section>

  <!-- ========== ESTADO DE REPORTE (con agrupar por analista) ========== -->
  <section id="cardReport" class="card">
    <h2>ESTADO DE REPORTE</h2>
    <div class="body">
      <div class="toolbar">
        <span class="muted">Vista:</span>
        <select id="viewSelect"><option value="mis">Asignados a mí</option><option value="todos">Todos (admin)</option></select>
        <span class="muted">Analista:</span>
        <select id="analystSelect"><option value="">Todos</option><option>Jose Salas</option><option>Sebastián Cataño</option><option>Sebastián Posada</option><option>Pablo Calle</option></select>
        <span class="muted">Estado:</span>
        <select id="statusSelect"><option value="">Todos</option><option value="pendientes">Pendientes</option><option>Abierto</option><option>En Proceso</option><option>Cerrado</option><option>Cancelado</option></select>
        <span class="muted">Mes:</span>
        <select id="monthSelect"><option value="">Todos</option></select>
        <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="groupByAnalyst"> Agrupar por analista</label>
        <span id="syncBadge" class="muted">Fuente: —</span>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="label">Total</div><div class="val" id="kpiTotal">0</div></div>
        <div class="kpi"><div class="label">Abiertos</div><div class="val" id="kpiAb">0</div></div>
        <div class="kpi"><div class="label">En proceso</div><div class="val" id="kpiPr">0</div></div>
        <div class="kpi"><div class="label">Cerrados</div><div class="val" id="kpiCe">0</div></div>
        <div class="kpi"><div class="label">Cancelados</div><div class="val" id="kpiCa">0</div></div>
        <div class="kpi"><div class="label">Con requerimiento</div><div class="val" id="kpiRq">0</div></div>
      </div>

      <div class="tablebox">
        <table>
          <thead>
            <tr>
              <th>Ticket</th><th>Analista</th><th>Categoría</th><th>Falla</th><th>Usuario</th>
              <th>Descripción</th><th>Prioridad</th><th>Estado</th><th>Fecha</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ========== PERMISOS EN SERVIDORES (ACL) ========== -->
  <section id="cardACL" class="card">
    <h2>PERMISOS EN SERVIDORES</h2>
    <div class="body">
      <details open>
        <summary><b>Registrar asignación</b></summary>
        <div class="grid" style="margin-top:10px">
          <div><label for="aclUsuario">Usuario</label><input id="aclUsuario" placeholder="Nombre (autocomplete)"></div>
          <div><label for="aclGrupo">Grupo</label><select id="aclGrupo"></select></div>
          <div><label for="aclRuta">Ruta</label><input id="aclRuta" readonly></div>
          <div><label for="aclTipo">Tipo permiso</label>
            <select id="aclTipo"><option>Lectura</option><option>Escritura</option><option>Control total</option></select>
          </div>
          <div><label for="aclAval">Aprobado por</label>
            <select id="aclAval"><option>David Guerrero</option><option>Diego Madera</option></select>
          </div>
          <div><label for="aclReq">Requerimiento</label><input id="aclReq" placeholder="REQ0000…"></div>
          <div><label for="aclObs">Observación</label><input id="aclObs" placeholder="Comentario opcional"></div>
        </div>
        <div class="row"><button id="aclSave" class="btn accent">Guardar permiso</button></div>
      </details>

      <details open style="margin-top:12px">
        <summary><b>Listado de permisos</b></summary>
        <div class="row" style="margin:10px 0">
          <input id="aclSearch" class="ctl" placeholder="Filtrar por usuario/grupo">
          <select id="aclEstado" class="ctl"><option value="">Todos</option><option>Activo</option><option>Revocado</option></select>
        </div>
        <div class="tablebox">
          <table>
            <thead>
              <tr>
                <th>ID</th><th>Usuario</th><th>Grupo</th><th>Ruta</th><th>Tipo</th>
                <th>Aprobado</th><th>Req.</th><th>Analista</th><th>Fecha</th><th>Estado</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody id="aclBody"></tbody>
          </table>
        </div>
      </details>
    </div>
  </section>
</main>

<!-- ===== MODAL REUTILIZABLE ===== -->
<dialog id="statusModal" class="modal">
  <header><h3 id="modalTitle" style="margin:0">Actualizar estado</h3></header>
  <div class="content">
    <label id="modalLabel" for="modalText" style="display:block;color:var(--muted);margin-bottom:6px">Detalle</label>
    <textarea id="modalText" class="ctl" style="width:100%"></textarea>
  </div>
  <footer>
    <button id="modalCancel" class="btn">Cancelar</button>
    <button id="modalOk" class="btn accent">Aceptar</button>
  </footer>
</dialog>

<footer>⚡ App HTML sincroniza con Google Sheets. Eliminación deshabilitada; usar estado “Cancelado”.</footer>

<script>
(function(){
'use strict';

/* ========== CONFIG ========== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwEj5huLdrgV_DOsBOAj_U5N4tXp625jqhZlmDOa3rN9o2bME2joGhE00k9LKwK9-RugQ/exec'; // <-- pega la URL de despliegue
const AUTO_REFRESH_MS = 30000;

const ANALISTAS = [
  { nombre:'Jose Salas',        email:'jsalas@sedic.com.co' },
  { nombre:'Sebastián Cataño',  email:'scatano@sedic.com.co' },
  { nombre:'Sebastián Posada',  email:'sposada@sedic.com.co' },
  { nombre:'Pablo Calle',       email:'pablocalle@ingetec.com.co' }
];

/* Usuarios: se pobla desde /contacts; este arreglo es fallback */
let USUARIOS = ['Marcela Pareja','Jhon Madrid','Juan Carlos Betancur','Heidy Zambrano','Andrés Gómez','Carlos Ramírez','Lina Areiza','Diana Pérez'];
/* Grupos ACL */
let ACL_GROUPS = []; // {grupo, ruta}

/* ========== DOM ========== */
const $ = s => document.querySelector(s);
const notice = $('#notice');
const tbody = $('#tbody'),
      kpiTotal=$('#kpiTotal'), kpiAb=$('#kpiAb'), kpiPr=$('#kpiPr'), kpiCe=$('#kpiCe'), kpiCa=$('#kpiCa'), kpiRq=$('#kpiRq');
const viewSelect = $('#viewSelect'), analystSelect = $('#analystSelect'),
      statusSelect = $('#statusSelect'), monthSelect = $('#monthSelect'),
      groupByAnalyst = $('#groupByAnalyst'),
      quickSearch = $('#quickSearch'), themePick = $('#themePick');
const form = $('#formTicket'), syncBadge = $('#syncBadge'), who = $('#whoami');

/* Modal */
const modal = $('#statusModal'), modalTitle = $('#modalTitle'),
      modalLabel = $('#modalLabel'), modalText = $('#modalText'),
      modalOk = $('#modalOk'), modalCancel = $('#modalCancel');

/* ACL DOM */
const aclUsuario = $('#aclUsuario'), aclGrupo = $('#aclGrupo'), aclRuta = $('#aclRuta'),
      aclTipo = $('#aclTipo'), aclAval = $('#aclAval'), aclReq = $('#aclReq'), aclObs = $('#aclObs'),
      aclBody = $('#aclBody'), aclSave = $('#aclSave'), aclSearch = $('#aclSearch'), aclEstado = $('#aclEstado');

/* ========== STATE ========== */
const localKey = 'tickets_fallas_v12';
const loadLocal = () => { try{ return JSON.parse(localStorage.getItem(localKey))||[] } catch { return [] } };
const saveLocal = v => localStorage.setItem(localKey, JSON.stringify(v));
let ticketsLocal = loadLocal();
let ticketsRemote = null;
let lastSource = 'Local';
let identity = null;
let AUTH_KEY = '';
let searchText = '';

/* ========== THEME ========== */
function applyBaseTheme(theme){ document.body.setAttribute('data-theme', theme); localStorage.setItem('ui_theme', theme); }
function applyAccent(hex){ document.documentElement.style.setProperty('--accent', hex); localStorage.setItem('ui_accent_hex', hex); }
(function initTheme(){
  const savedTheme = localStorage.getItem('ui_theme') || 'light';
  const savedAccent = localStorage.getItem('ui_accent_hex') || '#6475ff';
  applyBaseTheme(savedTheme); applyAccent(savedAccent);
  themePick.addEventListener('change', ()=>{
    const opt = themePick.selectedOptions[0];
    const theme = opt.dataset.theme; const hex = opt.dataset.hex;
    if (theme) applyBaseTheme(theme);
    if (hex)   applyAccent(hex);
  });
})();

/* ========== KEY ========== */
const keyInput = $('#keyInput'), saveKeyBtn = $('#saveKey'), clearKeyBtn = $('#clearKey');
(function initKey(){
  const urlKey = new URLSearchParams(location.search).get('key') || '';
  const stored = localStorage.getItem('auth_key') || '';
  AUTH_KEY = urlKey || stored || '';
  if (urlKey && urlKey !== stored) localStorage.setItem('auth_key', urlKey);
  keyInput.value = AUTH_KEY;
})();
saveKeyBtn.addEventListener('click', ()=>{ AUTH_KEY = keyInput.value.trim(); localStorage.setItem('auth_key', AUTH_KEY); fetchWhoAmI().then(fetchRemote); });
clearKeyBtn.addEventListener('click', ()=>{ AUTH_KEY=''; keyInput.value=''; localStorage.removeItem('auth_key'); fetchWhoAmI().then(fetchRemote); });

/* ========== ANALISTAS ========== */
(function initAnalistas(){
  const sel = $('#analista');
  sel.innerHTML = '<option value="">Selecciona…</option>' + ANALISTAS.map(a=>`<option value="${a.nombre}">${a.nombre}</option>`).join('');
})();

/* ========== AUTOCOMPLETE USUARIOS ========== */
const inputUsuario = $('#usuario'); const acList = $('#acList');
const norm = (s)=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
function filtraUsuarios(q){ const n=norm(q); if(!n) return []; return USUARIOS.filter(u=>norm(u).includes(n)).slice(0,8); }
function pintaLista(items){ if(!items.length){ acList.hidden=true; acList.innerHTML=''; return; } acList.innerHTML=items.map((t,i)=>`<li ${i===0?'aria-selected="true"':''}>${t}</li>`).join(''); acList.hidden=false; }
inputUsuario.addEventListener('input', ()=> pintaLista(filtraUsuarios(inputUsuario.value)));
inputUsuario.addEventListener('focus', ()=> pintaLista(filtraUsuarios(inputUsuario.value)));
document.addEventListener('click', (e)=>{ if (e.target.closest('#acList li')){ inputUsuario.value = e.target.textContent; acList.hidden = true; } else if(!e.target.closest('.ac')) { acList.hidden = true; } });

/* Plantillas: insertar en cursor */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.snippet-btn');
  if (!btn) return;
  const txt = btn.getAttribute('data-snippet') || '';
  const area = $('#descripcion');
  const {selectionStart:s, selectionEnd:ePos, value:v} = area;
  area.value = v.slice(0,s) + txt + v.slice(ePos);
  area.focus(); area.selectionStart = area.selectionEnd = s + txt.length;
});

/* REQ UI */
const reqSi = $('#reqSi'), reqNo = $('#reqNo'), reqNumber = $('#reqNumber');
function toggleReq(){ reqNumber.style.display = reqSi.checked ? '' : 'none'; }
reqSi.addEventListener('change', toggleReq); reqNo.addEventListener('change', toggleReq);

/* FILTROS */
(function fillMonths(){
  const now = new Date(); const items = ['<option value="">Todos</option>'];
  for (let i=0;i<12;i++){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const label = d.toLocaleDateString('es-CO', { month:'long', year:'numeric' });
    items.push(`<option value="${ym}">${label}</option>`);
  }
  monthSelect.innerHTML = items.join('');
})();
(function initView(){
  const saved = JSON.parse(localStorage.getItem('tickets_view')||'{}');
  viewSelect.value   = saved.view || 'mis';
  analystSelect.value= saved.analyst || '';
  statusSelect.value = saved.status || '';
  monthSelect.value  = saved.month || '';
  groupByAnalyst.checked = !!saved.grouped;
})();
function persistView(){
  localStorage.setItem('tickets_view', JSON.stringify({
    view:viewSelect.value, analyst:analystSelect.value, status:statusSelect.value, month:monthSelect.value, grouped:groupByAnalyst.checked
  }));
}
[viewSelect,analystSelect,statusSelect,monthSelect,groupByAnalyst].forEach(el => el.addEventListener('change', ()=>{ persistView(); render(); fetchRemote(); }));

/* SEARCH */
quickSearch.addEventListener('input', ()=>{ searchText = quickSearch.value; render(); });

/* HELPERS */
const show = (msg, kind='ok')=>{
  notice.style.display='block'; notice.textContent=msg;
  notice.style.borderColor=(kind==='ok')?'#b2f2bb':'#ffc9c9';
  setTimeout(()=> notice.style.display='none', 2200);
};
const esc   = s => String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
const trunc = (s,len=30)=>{ const t=String(s||''); return t.length>len ? t.slice(0,len)+'…' : t; };
const badge = p => `<span class="badge ${p==='Alta'?'prio-alta':p==='Media'?'prio-media':'prio-baja'}">${p||''}</span>`;
const tagE  = e => { const s = String(e||''); const cls = (s==='Abierto')?'e-abierto':(s==='En Proceso')?'e-proceso':(s==='Cerrado')?'e-cerrado':'e-cancelado'; return `<strong class="${cls}">${s}</strong>`; };
const fmt   = iso => { const d = (iso instanceof Date) ? iso : new Date(iso); return isNaN(d) ? '' : d.toLocaleString(); };

function computeCounters(rows){
  const c = { total:rows.length, abiertos:0, en_proceso:0, cerrados:0, cancelados:0, con_req:0 };
  rows.forEach(t=>{
    const s=String(t.estado||'').toLowerCase();
    if(s==='abierto') c.abiertos++; else if(s==='en proceso') c.en_proceso++; else if(s==='cerrado') c.cerrados++; else if(s==='cancelado') c.cancelados++;
    if (t.requerimiento) c.con_req++;
  });
  return c;
}
function setCounters(c){ kpiTotal.textContent=c.total; kpiAb.textContent=c.abiertos; kpiPr.textContent=c.en_proceso; kpiCe.textContent=c.cerrados; kpiCa.textContent=c.cancelados; kpiRq.textContent=c.con_req||0; }

function currentBaseRows(){
  const base = Array.isArray(ticketsRemote) ? ticketsRemote : ticketsLocal;
  lastSource = Array.isArray(ticketsRemote) ? 'Sheets' : 'Local';
  let rows = base.slice();
  const st = statusSelect.value;
  if (st==='pendientes'){ rows = rows.filter(x => !['Cerrado','Cancelado'].includes(String(x.estado))); }
  else if (st) rows = rows.filter(x => String(x.estado)===st);
  if (analystSelect.value) rows = rows.filter(x => String(x.analista)===analystSelect.value);
  if (monthSelect.value){
    rows = rows.filter(x => {
      const d = new Date(x.fecha);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      return ym === monthSelect.value;
    });
  }
  return rows;
}
function currentRows(){
  let rows = currentBaseRows();
  if (searchText && searchText.trim()){
    const n = searchText.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    rows = rows.filter(r => (`${r.id} ${r.categoria} ${r.falla} ${r.usuario} ${r.descripcion||''}`).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').includes(n));
  }
  rows.sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
  return rows;
}

/* ===== render (normal o agrupado) ===== */
function render(countersFromAPI){
  const rows = currentRows();
  if (countersFromAPI && lastSource==='Sheets') setCounters(countersFromAPI); else setCounters(computeCounters(rows));
  syncBadge.innerHTML = `Fuente: <strong>${lastSource}</strong>`;

  if (!groupByAnalyst.checked){
    tbody.innerHTML = rows.length ? rows.map(renderRow).join('') : `<tr><td colspan="10" style="text-align:center;color:#51608b">Sin resultados</td></tr>`;
    return;
  }

  // Agrupar por analista
  const byAnalyst = {};
  rows.forEach(r => { const key = r.analista || '(sin analista)'; (byAnalyst[key] = byAnalyst[key] || []).push(r); });
  const blocks = Object.keys(byAnalyst).sort().map(name=>{
    const list = byAnalyst[name];
    const inner = list.map(renderRow).join('');
    return `
      <tr><td colspan="10" style="padding:0">
        <details open>
          <summary style="padding:10px 12px;font-weight:700;background:color-mix(in srgb,var(--card) 92%, transparent);border-bottom:1px solid var(--border)">
            ${esc(name)} — ${list.length} caso(s)
          </summary>
          <table style="width:100%">
            <tbody>${inner}</tbody>
          </table>
        </details>
      </td></tr>`;
  }).join('');
  tbody.innerHTML = blocks || `<tr><td colspan="10" style="text-align:center;color:#51608b">Sin resultados</td></tr>`;
}

function renderRow(t){
  return `
  <tr>
    <td>${t.id||''}</td>
    <td>${esc(t.analista||'')}</td>
    <td>${esc(t.categoria||'')}</td>
    <td>${esc(t.falla||'')}</td>
    <td>${esc(t.usuario||'')}</td>
    <td>${t.descripcion ? `<span class="desc-peek" data-id="${t.id}" data-full="${esc(t.descripcion)}" title="Ver descripción completa">${esc(trunc(t.descripcion,30))}</span>` : '<span class="muted">—</span>'}</td>
    <td>${badge(t.prioridad||'')}</td>
    <td>${tagE(t.estado||'')}</td>
    <td>${fmt(t.fecha)}</td>
    <td style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <select class="estado-select" data-id="${t.id}">
        <option ${t.estado==='Abierto'?'selected':''}>Abierto</option>
        <option ${t.estado==='En Proceso'?'selected':''}>En Proceso</option>
        <option ${t.estado==='Cerrado'?'selected':''}>Cerrado</option>
        <option ${t.estado==='Cancelado'?'selected':''}>Cancelado</option>
      </select>
      <select class="prio-select" data-id="${t.id}">
        <option ${t.prioridad==='Alta'?'selected':''}>Alta</option>
        <option ${t.prioridad==='Media'?'selected':''}>Media</option>
        <option ${t.prioridad==='Baja'?'selected':''}>Baja</option>
      </select>
    </td>
  </tr>`;
}

/* ===== WHOAMI + LIST + CONTACTS + GROUPS ===== */
async function fetchWhoAmI(){
  try{
    const params = new URLSearchParams({ action:'whoami' }); if (AUTH_KEY) params.set('key', AUTH_KEY);
    const res = await fetch(WEB_APP_URL + '?' + params.toString());
    const data = await res.json();
    identity = data && data.ok ? data.me : null;
    who.textContent = identity ? `Identidad: ${identity.name} (${identity.role})` : 'Identidad: (no detectada)';
    const isAdmin = identity && identity.role==='admin';
    viewSelect.disabled = !isAdmin; if (!isAdmin) viewSelect.value = 'mis';
    if (identity && !analystSelect.value) analystSelect.value = identity.name;
  }catch{ identity = null; who.textContent = 'Identidad: (no detectada)'; }
}
async function fetchRemote(){
  try{
    const params = new URLSearchParams();
    params.set('action','list');
    params.set('view', viewSelect.value);
    if (analystSelect.value) params.set('analyst', analystSelect.value);
    if (statusSelect.value==='pendientes') params.set('state','pendientes');
    else if (statusSelect.value) params.set('status', statusSelect.value);
    if (monthSelect.value) params.set('ym', monthSelect.value);
    params.set('limit','1500');
    if (AUTH_KEY) params.set('key', AUTH_KEY);
    const res = await fetch(WEB_APP_URL + '?' + params.toString());
    const data = await res.json();
    if (data && data.ok && Array.isArray(data.items)){
      ticketsRemote = data.items;
      if (data.me){ identity = data.me; who.textContent = `Identidad: ${identity.name} (${identity.role})`; }
      render(data.counters);
    } else { ticketsRemote = null; render(); }
  }catch(err){ ticketsRemote = null; render(); }
}
async function fetchContacts(){
  try{
    const params = new URLSearchParams({ action:'contacts' }); if (AUTH_KEY) params.set('key', AUTH_KEY);
    const res = await fetch(WEB_APP_URL + '?' + params.toString());
    const data = await res.json();
    if (data && data.ok && Array.isArray(data.contacts) && data.contacts.length){
      USUARIOS = data.contacts;
    }
  }catch(e){}
}
async function fetchGroups(){
  try{
    const params = new URLSearchParams({ action:'groups' }); if (AUTH_KEY) params.set('key', AUTH_KEY);
    const res = await fetch(WEB_APP_URL + '?' + params.toString());
    const data = await res.json();
    if (data && data.ok && Array.isArray(data.groups)){
      ACL_GROUPS = data.groups.slice();
      aclGrupo.innerHTML = '<option value="">Selecciona…</option>' + ACL_GROUPS.map(g=>`<option value="${g.grupo}">${g.grupo}</option>`).join('');
    }
  }catch(e){}
}

/* ===== POST util ===== */
async function postJSON(payload){
  if (AUTH_KEY) payload.key = AUTH_KEY;
  const res = await fetch(WEB_APP_URL, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
  try { return await res.json(); } catch { return { ok:false, error:'Respuesta no-JSON' }; }
}

/* ===== CREAR TICKET ===== */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const analista   = $('#analista').value;
  const categoria  = $('#categoria').value;
  const falla      = $('#falla').value;
  const usuario    = $('#usuario').value.trim();
  const prioridad  = $('#prioridad').value;
  const descripcion= $('#descripcion').value.trim();

  const tieneReq = $('#reqSi').checked;
  const reqNum   = $('#reqNumber').value.trim();
  if (tieneReq && !reqNum){ show('Escribe el número de requerimiento','err'); $('#reqNumber').focus(); return; }

  if(!analista || !categoria || !falla || !usuario || !prioridad){ show('Completa los campos obligatorios','err'); return; }

  const correoAnalista = (ANALISTAS.find(a=>a.nombre===analista)?.email) || '';
  const id = 'T' + new Date().toISOString().replace(/\D/g,'').slice(0,14);
  const nowISO = new Date().toISOString();

  const t = { id, analista, correoAnalista, categoria, falla, usuario, prioridad, descripcion, requerimiento: tieneReq ? `REQ-${reqNum}` : '', estado:'Abierto', fecha: nowISO };
  ticketsLocal.unshift(t); saveLocal(ticketsLocal); render(); show('Guardado local. Enviando a Sheets…');

  const d = await postJSON({ action:'create', id:t.id, analista, correoAnalista, categoria, falla, usuario, prioridad, descripcion, estado:t.estado, fechaISO: nowISO, requerimiento: t.requerimiento });
  if (!d || !d.ok){ show('No se pudo crear en Sheets', 'err'); } else { fetchRemote(); }
  form.reset(); toggleReq();
});

/* ===== MODAL REUTILIZABLE (fix: respeta presetValue) ===== */
function askModal({title,label,placeholder='', required=false, readonly=false, okText='Aceptar', presetValue='' }){
  return new Promise(resolve=>{
    modalTitle.textContent = title;
    modalLabel.textContent = label;
    modalText.required = required;
    modalText.readOnly  = !!readonly;
    modalText.placeholder = placeholder || '';
    modalOk.textContent = okText;
    modalText.value = presetValue;  // <- importante: NO vaciar si viene pre-cargado

    const onOk = ()=>{ if(required && !modalText.value.trim()){ modalText.focus(); return; } cleanup(); modal.close(); resolve({ok:true, text: modalText.value.trim()}); };
    const onCancel = ()=>{ cleanup(); modal.close(); resolve({ok:false}); };
    function cleanup(){ modalOk.removeEventListener('click', onOk); modalCancel.removeEventListener('click', onCancel); modal.removeEventListener('cancel', onCancel); }
    modalOk.addEventListener('click', onOk);
    modalCancel.addEventListener('click', onCancel);
    modal.addEventListener('cancel', onCancel);
    modal.showModal();
    setTimeout(()=>modalText.focus(), 50);
  });
}

/* Guardar valor previo del select para revertir cancelaciones */
document.addEventListener('focusin',(e)=>{ const s = e.target.closest('.estado-select'); if (s) s.dataset.prev = s.value; });

/* Ver descripción completa (solo lectura) */
document.addEventListener('click', async (e)=>{
  const peek = e.target.closest('.desc-peek');
  if (!peek) return;
  const full = peek.dataset.full || '';
  await askModal({ title:'Descripción completa', label:'Descripción', readonly:true, okText:'Cerrar', presetValue: full });
});

/* Cambios de estado/prioridad */
document.addEventListener('change', async (e)=>{
  const selE = e.target.closest('.estado-select');
  const selP = e.target.closest('.prio-select');

  if (selE){
    const id = selE.dataset.id;
    const newStatus = selE.value;
    const prev = selE.dataset.prev || 'Abierto';

    if (newStatus === 'Cancelado'){
      const r = await askModal({title:'Cancelar ticket', label:'Motivo de cancelación', placeholder:'Describe el motivo…', required:true});
      if (!r.ok){ selE.value = prev; return; }
      const tL = ticketsLocal.find(x=>x.id===id);
      if (tL){ tL.estado=newStatus; tL.motivo=r.text; tL.fecha=new Date().toISOString(); saveLocal(ticketsLocal); }
      render();
      const d = await postJSON({ action:'update_status', id, status:newStatus, reason:r.text });
      if (d && d.ok) fetchRemote();
      return;
    }
    if (newStatus === 'Cerrado'){
      const r = await askModal({title:'Cerrar ticket', label:'Solución aplicada', placeholder:'Describe la solución brindada…', required:true});
      if (!r.ok){ selE.value = prev; return; }
      const tL = ticketsLocal.find(x=>x.id===id);
      if (tL){ tL.estado=newStatus; tL.solucion=r.text; tL.fecha=new Date().toISOString(); saveLocal(ticketsLocal); }
      render();
      const d = await postJSON({ action:'update_status', id, status:newStatus, solution:r.text });
      if (d && d.ok) fetchRemote();
      return;
    }
    const tL = ticketsLocal.find(x=>x.id===id);
    if (tL){ tL.estado=newStatus; tL.fecha=new Date().toISOString(); saveLocal(ticketsLocal); }
    render();
    const d2 = await postJSON({ action:'update_status', id, status:newStatus });
    if (d2 && d2.ok) fetchRemote();
  }

  if (selP){
    const id = selP.dataset.id; const pr = selP.value;
    const tL = ticketsLocal.find(x=>x.id===id);
    if (tL){ tL.prioridad=pr; tL.fecha=new Date().toISOString(); saveLocal(ticketsLocal); }
    render();
    const d3 = await postJSON({ action:'update_priority', id, prioridad: pr });
    if (d3 && d3.ok) fetchRemote();
  }
});

/* ===== ACL: UI ===== */
function fillAclGrupoRuta(){
  const g = aclGrupo.value;
  const obj = ACL_GROUPS.find(x => x.grupo === g);
  aclRuta.value = obj ? obj.ruta : '';
}
aclGrupo.addEventListener('change', fillAclGrupoRuta);
/* Autocomplete simple para ACL usuario (re-usa USUARIOS) */
aclUsuario.addEventListener('input', ()=>{/* nada especial; es libre */});

/* Guardar ACL */
aclSave.addEventListener('click', async ()=>{
  const payload = {
    action:'acl_upsert',
    usuario: aclUsuario.value.trim(),
    grupo: aclGrupo.value,
    ruta: aclRuta.value.trim(),
    tipoPermiso: aclTipo.value,
    aprobadoPor: aclAval.value,
    requerimiento: aclReq.value.trim(),
    observacion: aclObs.value.trim(),
    ticketId: '', // opcional
    analista: identity?.name || ''
  };
  if (!payload.usuario || !payload.grupo || !payload.ruta){ show('Completa Usuario, Grupo y Ruta', 'err'); return; }
  const r = await postJSON(payload);
  if (r && r.ok){ show('Permiso registrado'); aclUsuario.value=''; aclReq.value=''; aclObs.value=''; await loadAclList(); }
  else show('No se pudo registrar', 'err');
});

/* Listado ACL + revocar */
async function loadAclList(){
  const params = new URLSearchParams({ action:'acl_list' });
  if (aclEstado.value) params.set('estado', aclEstado.value);
  if (AUTH_KEY) params.set('key', AUTH_KEY);
  const res = await fetch(WEB_APP_URL + '?' + params.toString());
  const data = await res.json();
  let items = Array.isArray(data.items) ? data.items : [];

  const q = aclSearch.value.trim().toLowerCase();
  if (q) items = items.filter(x => `${x.usuario} ${x.grupo}`.toLowerCase().includes(q));

  aclBody.innerHTML = items.length ? items.map(x => `
    <tr>
      <td>${x.id}</td><td>${esc(x.usuario)}</td><td>${esc(x.grupo)}</td><td>${esc(x.ruta)}</td>
      <td>${x.tipo}</td><td>${esc(x.aprobadoPor)}</td><td>${esc(x.req)}</td><td>${esc(x.analista)}</td>
      <td>${fmt(x.fecha)}</td><td>${x.estado}</td>
      <td>${x.estado==='Activo' ? `<button class="btn secondary acl-rev" data-id="${x.id}">Revocar</button>` : ''}</td>
    </tr>
  `).join('') : `<tr><td colspan="11" style="text-align:center;color:#51608b">Sin permisos</td></tr>`;
}
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('.acl-rev');
  if (!btn) return;
  const id = btn.dataset.id;
  const ok = confirm('¿Revocar este permiso?');
  if (!ok) return;
  const r = await postJSON({ action:'acl_revoke', id });
  if (r && r.ok){ show('Permiso revocado'); loadAclList(); } else show('No se pudo revocar', 'err');
});
aclSearch.addEventListener('input', loadAclList);
aclEstado.addEventListener('change', loadAclList);

/* ===== INIT ===== */
async function init(){
  await fetchWhoAmI();
  await fetchContacts();
  await fetchGroups();
  fillAclGrupoRuta();
  if (identity && !analystSelect.value) analystSelect.value = identity.name;
  render();
  fetchRemote();
  loadAclList();
  setInterval(()=>{ if(!document.hidden) fetchRemote(); }, AUTO_REFRESH_MS);
}
init();

})();
</script>
</body>
</html>
