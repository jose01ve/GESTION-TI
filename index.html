<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión TI · Reporte de fallas</title>

  <style>
    /* ========= 01) VARIABLES DE TEMA ========= */
    :root{
      --accent:#6475ff;                     /* color de acento (se puede cambiar en runtime) */
      --bg:#eef2ff; --card:#ffffff; --text:#0d1333; --muted:#51608b;
      --border:rgba(13,19,51,.12); --field:#fbfcff;
    }
    body[data-theme="dark"]{ --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9aa4bf; --border:rgba(255,255,255,.15); --field:#0b1220 }
    body[data-theme="mint"]{ --bg:#e6fff4; --card:#ffffff; --text:#0d1333; --muted:#4d6a61; --border:rgba(13,19,51,.12); --field:#f7fffb }
    body[data-theme="blue"]{ --bg:#e7f3ff; --card:#ffffff; --text:#0f1a2b; --muted:#3c587a; --border:rgba(15,26,43,.12); --field:#f7fbff }
    body[data-theme="navy"]{ --bg:#0b1629; --card:#0f2038; --text:#ebf1ff; --muted:#9fb3d1; --border:rgba(255,255,255,.14); --field:#0c1b30 }

    /* ========= 02) BASE ========= */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif }

    /* ========= 03) TOPBAR ========= */
    header{position:sticky; top:0; z-index:20; padding:4px 0}
    .toprow{ max-width:1680px; margin:0 auto; padding:0 16px; display:flex; align-items:center; gap:12px; justify-content:flex-end }
    .chip{font-size:.9rem; color:var(--muted)}
    .ctl,.btn-sm{ height:36px; padding:6px 10px; border:1px solid var(--border); border-radius:10px; background:var(--field); color:var(--text) }
    .btn-sm{ background:var(--card); cursor:pointer }
    .btn-sm.accent{ background:var(--accent); border-color:var(--accent); color:#fff }
    #themePick{ width:180px }

    /* ========= 04) LOGO ========= */
    .logoWrap{ max-width:1680px; margin:0 auto; padding:0 16px 6px; display:flex; justify-content:flex-start }
    .logo{ height:clamp(84px, 10vh, 120px); opacity:.92; mix-blend-mode:multiply; filter:saturate(.9) contrast(1.06) brightness(1.03) }

    /* ========= 05) LAYOUT ========= */
    :root{ --stickyTop:58px }
    main{ max-width:1680px; margin:4px auto 12px; padding:0 16px; display:grid; gap:16px }
    @media(min-width:1200px){ main{ grid-template-columns:640px 1fr } }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 24px rgba(13,19,51,.08) }
    .card h2{ position:sticky; top:0; z-index:2; margin:0; padding:12px 16px; background:linear-gradient(180deg,color-mix(in srgb,var(--card) 98%,transparent), color-mix(in srgb,var(--card) 92%,transparent)); border-bottom:1px solid var(--border) }
    .card .body{ padding:16px }
    /* Form de la izquierda siempre fijo */
    #cardForm{ position:sticky; top:var(--stickyTop); align-self:start; max-height:calc(100vh - var(--stickyTop) - 8px); overflow:auto }

    /* ========= 06) FORMULARIO ========= */
    form .grid{ display:grid; gap:12px }
    @media(min-width:560px){ form .grid{ grid-template-columns:1fr 1fr } }
    label{ font-size:.9rem; color:var(--muted); display:block; margin-bottom:6px }
    input,select,textarea{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--field); color:var(--text) }
    textarea{ min-height:96px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
    .btn{ border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer }
    .btn.accent{ background:var(--accent); color:#fff; border-color:var(--accent); box-shadow:0 8px 16px color-mix(in srgb,var(--accent) 25%, transparent) }
    .btn.secondary{ background:color-mix(in srgb,var(--accent) 10%, var(--card)); border-color:color-mix(in srgb,var(--accent) 30%, var(--border)) }
    .btn.secondary:hover{ background:color-mix(in srgb,var(--accent) 14%, var(--card)) }

    .mini{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px }
    .mini h3{ margin:0 0 8px 0; font-size:1rem }
    .mini ul{ margin:0 0 0 18px; padding:0 }
    .mini .dot{ font-weight:700; margin-right:6px }

    details.snippets summary{ cursor:pointer; user-select:none; color:var(--muted); padding:8px 0; font-weight:600 }
    .snippet-btn{ border:1px dashed var(--border); background:color-mix(in srgb,var(--accent) 8%, var(--card)); border-radius:10px; padding:8px 10px; cursor:pointer }
    .snippet-btn:hover{ background:color-mix(in srgb,var(--accent) 12%, var(--card)) }

    /* ========= 07) KPIs y TABLA ========= */
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0 12px }
    .toolbar select{ padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:var(--field) }
    .muted{ color:var(--muted); font-size:.9rem }
    .kpis{ display:grid; grid-template-columns:repeat(6,minmax(160px,1fr)); gap:12px; margin-bottom:8px }
    .kpi{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px }
    .kpi .label{ font-size:.88rem; color:var(--muted); white-space:nowrap }
    .kpi .val{ font-weight:800; font-size:1.25rem }
    .tablebox{ overflow:auto; max-height: calc(100vh - 320px) }
    table{ width:100%; border-collapse:separate; border-spacing:0 10px; color:var(--text) }
    thead th{ position:sticky; top:0; z-index:1; font-size:.86rem; color:var(--muted); text-align:left; padding:0 8px; white-space:nowrap; background: color-mix(in srgb, var(--card) 92%, transparent) }
    tbody tr{ background:var(--card); border:1px solid var(--border) }
    tbody td{ padding:10px 8px; vertical-align:top }
    tbody tr:hover{ box-shadow:0 0 0 2px color-mix(in srgb,var(--accent) 18%, transparent) inset }
    .badge{ padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:.78rem; white-space:nowrap }
    .prio-alta{ background:#fff5f5 } .prio-media{ background:#fff4e6 } .prio-baja{ background:#ebfbee }
    body[data-theme="dark"] .prio-alta{ background:#402b2b } body[data-theme="dark"] .prio-media{ background:#3e2f18 } body[data-theme="dark"] .prio-baja{ background:#1b3b2a }
    .e-abierto{ color:#e03131 } .e-proceso{ color:#f08c00 } .e-cerrado{ color:#2b8a3e } .e-cancelado{ color:#6b7280 }

    /* ========= 08) AUTOCOMPLETE ========= */
    .ac{ position:relative }
    .ac-list{ position:absolute; left:0; right:0; top:100%; background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:0 10px 24px rgba(13,19,51,.08); margin-top:6px; max-height:220px; overflow:auto; padding:6px; z-index:5 }
    .ac-list[hidden]{ display:none }
    .ac-list li{ list-style:none; padding:8px 12px; cursor:pointer; border-radius:10px }
    .ac-list li[aria-selected="true"], .ac-list li:hover{ background:color-mix(in srgb,var(--accent) 10%, transparent) }

    .notice{ display:none; margin-top:10px; padding:10px 12px; border:1px solid var(--border); border-radius:10px }
    footer{ max-width:1680px; margin:6px auto 28px; padding:0 16px; color:var(--muted); font-size:.9rem }

    /* ========= 09) MODAL (dialog) ========= */
    dialog.modal{
      width:min(560px, 92vw);
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--card);
      color:var(--text);
      padding:0;
    }
    dialog::backdrop{ background:rgba(0,0,0,.35); backdrop-filter:saturate(110%) blur(3px) }
    .modal header{ padding:14px 16px; border-bottom:1px solid var(--border) }
    .modal .content{ padding:16px }
    .modal footer{ padding:12px 16px; display:flex; gap:10px; justify-content:flex-end }
    .modal textarea{ min-height:120px }
    .desc-peek{ cursor:pointer; text-decoration:underline; text-underline-offset:2px; }

    /* Columna de Fecha: ancho mínimo y sin salto de línea */
   .col-date { min-width: 130px; white-space: nowrap; }
   /* Aplica también al cuerpo, 9na columna = Fecha */
   tbody td:nth-child(9) { min-width: 130px; white-space: nowrap; }

    /* Evita que se “aplasten” las últimas columnas */
table{ min-width: 1200px; }

/* Anchos mínimos y no cortar fechas */
.col-date,
.col-date-close { min-width:130px; white-space:nowrap; }

/* También aplicar por índice en el cuerpo */
tbody td:nth-child(9),
tbody td:nth-child(10){ min-width:130px; white-space:nowrap; }

/* Asegurar espacio para Acciones */
.col-actions{ min-width:160px; }
tbody td:nth-child(11){ min-width:160px; }

  </style>
</head>
<body data-theme="light">
  <!-- ====== Barra superior ====== -->
  <header>
    <div class="toprow">
      <small id="whoami" class="chip">Identidad: (no detectada)</small>
      <input id="keyInput" class="ctl" placeholder="Clave (opcional)" style="width:160px">
      <button id="saveKey" class="btn-sm accent">Guardar</button>
      <button id="clearKey" class="btn-sm" title="Olvidar">✕</button>

      <!-- Selector de tema base + acento por HEX -->
      <select id="themePick" class="ctl" title="Tema">
        <optgroup label="Tema base">
          <option value="Claro"        data-theme="light">Tema: Claro (verde)</option>
          <option value="Oscuro"       data-theme="dark">Tema: Oscuro</option>
          <option value="Mint"         data-theme="mint">Tema: Mint</option>
          <option value="Azul"         data-theme="blue">Tema: Azul</option>
          <option value="Azul oscuro"  data-theme="navy">Tema: Azul oscuro</option>
        </optgroup>
        <optgroup label="Color de acento (HEX)">
          <option value="Verde"        data-hex="#92e87c">Acento: Verde</option>
          <option value="Amarillo"     data-hex="#ffe764">Acento: Amarillo</option>
          <option value="Rojo"         data-hex="#e74176">Acento: Rojo</option>
          <option value="Azul"         data-hex="#0040a8">Acento: Azul</option>
          <option value="Azul claro"   data-hex="#20a1d8">Acento: Azul claro</option>
          <option value="Azul oscuro"  data-hex="#003f84">Acento: Azul oscuro</option>
        </optgroup>
      </select>
    </div>
  </header>

  <!-- ====== Logo ====== -->
  <div class="logoWrap">
    <img class="logo" src="Imagen/logo-empresas.jpg" alt="INGETEC / SEDIC · Proyecto Hidroeléctrico Ituango"
         loading="lazy" onerror="this.onerror=null;this.src='https://jose01ve.github.io/GESTION-TI/Imagen/logo-empresas.jpg';">
  </div>

  <main>
    <!-- ===================== REPORTE USUARIO ===================== -->
    <section id="cardForm" class="card">
      <h2>REPORTE USUARIO</h2>
      <div class="body">
        <form id="formTicket" action="javascript:void(0)" autocomplete="off">
          <div class="grid">
            <div>
              <label for="analista">Analista Responsable *</label>
              <select id="analista" required></select>
            </div>

            <div>
              <label for="categoria">Categoría *</label>
              <select id="categoria" required>
                <option value="">Selecciona…</option>
                <option>Red</option><option>Hardware</option><option>Software</option><option>Asesoría</option><option>Préstamo de activo</option>
                <option>Correo</option><option>Impresión</option><option>Mantenimiento</option><option>Servidores</option><option>Otro</option>
              </select>
            </div>

            <div>
              <label for="falla">Servicio prestado *</label>
              <select id="falla" required>
                <option value="">Selecciona…</option>
                <!-- (catálogo recortado por espacio) -->
                <option>Soporte a equipos informáticos</option>
                <option>Configuración equipo</option>
                <option>Desbloquear cuenta de red</option>
                <option>Préstamo Video Beam / Préstamo equipo</option>
                <option>Crear acta</option>
                <option>Instalación de PC-Dis \ Préstamo de equipo \ Dispositivo</option>
                <option>Reposición de equipo</option>
                <option>Retiro de equipo a usuario</option>
                <option>Traslado de puesto</option>
                <option>Instalación de software - Desinstalación \ Traslado SW</option>
                <option>Adquisición de Software y Hardware</option>
                <option>Asignación de puesto nuevo</option>
                <option>Creación de cuentas de red</option>
                <option>Eliminación de cuentas de red</option>
                <option>Crear cuenta de correo \ Eliminar</option>
                <option>Actualización de datos \ Información</option>
                <option>Inventario de Equipos</option>
                <option>Inventario de software</option>
                <option>Actualización de cuentas de red</option>
                <option>Asignar Permiso en servidores \ Retirar permisos</option>
                <option>Permisos en Unidades compartidas</option>
                <option>Soporte equipos CONSORCIO</option>
                <option>Auditoria desde TIC a Interventoría</option>
                <option>Instalación de Guayas</option>
                <option>Backups información</option>
                <option>Resolución de ECOS</option>
                <option>Actualización de carpetas de información general</option>
                <option>Actualización de información CADD</option>
                <option>Capacitación</option>
                <option>Reposición de equipos EPM</option>
                <option>Asesoría general</option>
                <option>Permisos en Skype Empresarial</option>
                <option>Desinstalación de programas</option>
                <option>Requerimiento de Impresión</option>
                <option>Gestión en Vault</option>
                <option>Permisos VPN</option>
                <option>Gestión en obra</option>
                <option>Crear cuenta de correo</option>
                <option>Entrega de equipo por reintegro o reposición</option>
                <option>Configurar Dispositivo móvil</option>
                <option>Marcación de puestos</option>
                <option>Recuperación de información</option>
                <option>Gestión aplicaciones</option>
              </select>
            </div>

            <div class="ac">
              <label for="usuario">Usuario quien reporta *</label>
              <input id="usuario" placeholder="Escribe nombre o apellido" required />
              <ul id="acList" class="ac-list" hidden></ul>
              <small class="help">Escribe y elige entre las sugerencias.</small>
            </div>

            <div>
              <label for="prioridad">Prioridad *</label>
              <select id="prioridad" required>
                <option value="">Selecciona…</option><option>Alta</option><option>Media</option><option>Baja</option>
              </select>
            </div>

            <!-- Reemplaza “Adjunto” por número de requerimiento -->
            <div>
              <label>¿Tiene requerimiento?</label>
              <div class="row" style="margin-top:0">
                <label style="display:flex;align-items:center;gap:6px">
                  <input type="radio" name="hasReq" value="no" id="reqNo" checked> No
                </label>
                <label style="display:flex;align-items:center;gap:6px">
                  <input type="radio" name="hasReq" value="si" id="reqSi"> Sí
                </label>
                <input id="reqNumber" class="ctl" placeholder="Número de requerimiento" style="flex:1;min-width:180px;display:none">
              </div>
              <small class="help">Si eliges “Sí”, debes escribir el número antes de guardar.</small>
            </div>
          </div>

          <div style="margin-top:10px">
            <label for="descripcion">Descripción (opcional)</label>
            <textarea id="descripcion" placeholder="Describe el problema reportado…"></textarea>

            <!-- Plantillas de descripción -->
            <details class="snippets" open>
              <summary>► Plantillas de descripción</summary>
              <div class="row" style="margin-top:8px">
                <button type="button" class="snippet-btn" data-snippet="Usuario se comunica e informa tener problemas de acceso al servidor/equipo/recurso compartido con nombre xxxx.">Soporte informático</button>
                <button type="button" class="snippet-btn" data-snippet="El usuario informa no puede imprimir o que la impresora presenta fallos (atasco de papel, sin conexión, sin tinta, o no aparece en red).">Problemas de impresión</button>
                <button type="button" class="snippet-btn" data-snippet="Se requiere realizar la instalación/desinstalación del programa xxx en el equipo con serial xxx y nombre xxx.">Instalación/desinstalación de software</button>
                <button type="button" class="snippet-btn" data-snippet="Gestionar permisos en servidores/VPN.">Permisos servidores/VPN</button>
                <button type="button" class="snippet-btn" data-snippet="Gestionar creación de cuenta de red/correo o eliminación.">Crear cuenta de red/correo/eliminar</button>
                <button type="button" class="snippet-btn" data-snippet="Usuario reporta tener la cuenta de red bloqueada. Se desbloquea la cuenta de red indicada, se hacen pruebas y estas son satisfactorias.">Desbloquear cuenta de red</button>
                <button type="button" class="snippet-btn" data-snippet="Usuario informa tener problemas con la APP XXX.">Problemas con aplicaciones</button>
              </div>
            </details>
          </div>

          <div id="notice" class="notice"></div>
          <div class="row">
            <button class="btn accent" type="submit">➕ Guardar reporte</button>
            <button class="btn secondary" type="reset">↺ Limpiar</button>
            <input id="quickSearch" class="ctl" style="flex:1; min-width:220px" placeholder="Buscar tickets (ID, categoría, falla, usuario)">
          </div>

          <div class="row">
            <div class="mini" style="flex:1 1 280px">
              <h3>Checklist antes de crear</h3>
              <ul>
                <li><span class="dot">•</span>Confirmar datos del usuario y equipo.</li>
                <li><span class="dot">•</span>Clasificar <em>Categoría</em> y <em>Servicio prestado</em>.</li>
                <li><span class="dot">•</span>Describir impacto (usuarios/áreas afectadas).</li>
                <li><span class="dot">•</span>Estimar prioridad (Alta/Media/Baja) según impacto.</li>
              </ul>
            </div>
            <div class="mini" style="flex:1 1 260px">
              <h3>Leyenda rápida</h3>
              <p><span class="badge prio-alta">Alta</span> incidente crítico o bloqueo.</p>
              <p><span class="badge prio-media">Media</span> afecta tareas, tiene alternativa.</p>
              <p><span class="badge prio-baja">Baja</span> consulta o mantenimiento.</p>
            </div>
          </div>
        </form>
      </div>
    </section>

    <!-- ===================== ESTADO DE REPORTE ===================== -->
    <section id="cardReport" class="card">
      <h2>ESTADO DE REPORTE</h2>
      <div class="body">
        <div class="toolbar">
          <span class="muted">Vista:</span>
          <select id="viewSelect"><option value="mis">Asignados a mí</option><option value="todos">Todos (admin)</option></select>

          <span class="muted">Analista:</span>
          <select id="analystSelect"><option value="">Todos</option><option>Jose Salas</option><option>Sebastián Cataño</option><option>Sebastián Posada</option><option>Pablo Calle</option></select>

          <span class="muted">Estado:</span>
          <select id="statusSelect"><option value="">Todos</option><option value="pendientes">Pendientes</option><option value="Abierto">Abierto</option><option value="En Proceso">En Proceso</option><option value="Cerrado">Cerrado</option><option value="Cancelado">Cancelado</option></select>

          <span class="muted">Mes:</span>
          <select id="monthSelect"><option value="">Todos</option></select>

          <span id="syncBadge" class="muted">Fuente: —</span>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="label">Total</div><div class="val" id="kpiTotal">0</div></div>
          <div class="kpi"><div class="label">Abiertos</div><div class="val" id="kpiAb">0</div></div>
          <div class="kpi"><div class="label">En proceso</div><div class="val" id="kpiPr">0</div></div>
          <div class="kpi"><div class="label">Cerrados</div><div class="val" id="kpiCe">0</div></div>
          <div class="kpi"><div class="label">Cancelados</div><div class="val" id="kpiCa">0</div></div>
          <div class="kpi"><div class="label">Con requerimiento</div><div class="val" id="kpiRq">0</div></div>
        </div>

        <div class="tablebox">
          <table>
             <thead>
  <tr>
    <th>Ticket</th>
    <th>Analista</th>
    <th>Categoría</th>
    <th>Falla</th>
    <th>Usuario</th>
    <th>Descripción</th><!-- vista truncada + clic -->
    <th>Prioridad</th>
    <th>Estado</th>
    <th class="col-date">Creación</th>
    <th class="col-date-close">Cierre</th>
    <th class="col-actions">Acciones</th>
  </tr>
</thead>

          <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- ========= MODAL DE ESTADO / TEXTO (reutilizable) ========= -->
  <dialog id="statusModal" class="modal">
    <header><h3 id="modalTitle" style="margin:0">Actualizar estado</h3></header>
    <div class="content">
      <label id="modalLabel" for="modalText" style="display:block; color:var(--muted); margin-bottom:6px">Detalle</label>
      <textarea id="modalText" class="ctl" style="width:100%"></textarea>
    </div>
    <footer>
      <button id="modalCancel" class="btn">Cancelar</button>
      <button id="modalOk" class="btn accent">Aceptar</button>
    </footer>
  </dialog>

  <footer>⚡ App HTML sincroniza con Google Sheets. Eliminación deshabilitada; usar estado “Cancelado”.</footer>

  <script>
  (function(){
    'use strict';

    /* ==================== CONFIG ==================== */
    /* Pega aquí la URL de despliegue de tu Apps Script (la más reciente) */
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiValBUVUeBfB2QXKlaQJhRwrEFjRxYdngW_ChHCmKMma3bLZ5CpUAOYaMfIwvXKJvyg/exec';
    const AUTO_REFRESH_MS = 30000;

    const ANALISTAS = [
      { nombre:'Jose Salas',        email:'jsalas@sedic.com.co' },
      { nombre:'Sebastián Cataño',  email:'scatano@sedic.com.co' },
      { nombre:'Sebastián Posada',  email:'sposada@sedic.com.co' },
      { nombre:'Pablo Calle',       email:'pablocalle@ingetec.com.co' }
    ];

    /* USUARIOS: se llenará desde Sheets vía endpoint /contacts; este arreglo es fallback */
    let USUARIOS = ['Marcela Pareja','Jhon Madrid','Juan Carlos Betancur','Heidy Zambrano','Andrés Gómez','Carlos Ramírez','Lina Areiza','Diana Pérez'];

    /* ==================== DOM ==================== */
    const $ = s => document.querySelector(s);
    const notice = $('#notice');
    const tbody = $('#tbody'),
          kpiTotal=$('#kpiTotal'), kpiAb=$('#kpiAb'), kpiPr=$('#kpiPr'), kpiCe=$('#kpiCe'), kpiCa=$('#kpiCa'), kpiRq=$('#kpiRq');
    const viewSelect = $('#viewSelect'), analystSelect = $('#analystSelect'),
          statusSelect = $('#statusSelect'), monthSelect  = $('#monthSelect'),
          quickSearch = $('#quickSearch'), themePick = $('#themePick');
    const form = $('#formTicket'), syncBadge = $('#syncBadge'), who = $('#whoami');

    /* Modal (reutilizable para estados y ver descripción) */
    const modal = $('#statusModal'), modalTitle = $('#modalTitle'),
          modalLabel = $('#modalLabel'), modalText = $('#modalText'),
          modalOk = $('#modalOk'), modalCancel = $('#modalCancel');

    /* ==================== STATE ==================== */
    const localKey = 'tickets_fallas_v12';
    const loadLocal = () => { try{ return JSON.parse(localStorage.getItem(localKey))||[] } catch { return [] } };
    const saveLocal = v => localStorage.setItem(localKey, JSON.stringify(v));
    let ticketsLocal = loadLocal();
    let ticketsRemote = null;
    let lastSource = 'Local';
    let identity = null;
    let AUTH_KEY = '';
    let searchText = '';

    /* ==================== TEMA ==================== */
    function applyBaseTheme(theme){ document.body.setAttribute('data-theme', theme); localStorage.setItem('ui_theme', theme); }
    function applyAccent(hex){ document.documentElement.style.setProperty('--accent', hex); localStorage.setItem('ui_accent_hex', hex); }
    (function initTheme(){
      const savedTheme = localStorage.getItem('ui_theme') || 'light';
      const savedAccent = localStorage.getItem('ui_accent_hex') || getDefaultAccentFor(savedTheme);
      applyBaseTheme(savedTheme); applyAccent(savedAccent);
      themePick.addEventListener('change', ()=>{
        const opt = themePick.selectedOptions[0];
        const theme = opt.dataset.theme;
        const hex   = opt.dataset.hex;
        if (theme) applyBaseTheme(theme);
        if (hex)   applyAccent(hex);
      });
    })();
    function getDefaultAccentFor(theme){
      switch(theme){
        case 'dark': return '#93c5fd';
        case 'mint': return '#16a34a';
        case 'blue': return '#0ea5e9';
        case 'navy': return '#4f7cff';
        default:     return '#6475ff';
      }
    }

    /* ==================== CLAVE OPCIONAL ==================== */
    const keyInput = $('#keyInput'), saveKeyBtn = $('#saveKey'), clearKeyBtn = $('#clearKey');
    (function initKey(){
      const urlKey = new URLSearchParams(location.search).get('key') || '';
      const stored = localStorage.getItem('auth_key') || '';
      AUTH_KEY = urlKey || stored || '';
      if (urlKey && urlKey !== stored) localStorage.setItem('auth_key', urlKey);
      keyInput.value = AUTH_KEY;
    })();
    saveKeyBtn.addEventListener('click', ()=>{ AUTH_KEY = keyInput.value.trim(); localStorage.setItem('auth_key', AUTH_KEY); fetchWhoAmI().then(fetchRemote); });
    clearKeyBtn.addEventListener('click', ()=>{ AUTH_KEY=''; keyInput.value=''; localStorage.removeItem('auth_key'); fetchWhoAmI().then(fetchRemote); });

    /* ==================== ANALISTAS ==================== */
    (function initAnalistas(){
      const sel = $('#analista');
      sel.innerHTML = '<option value="">Selecciona…</option>' + ANALISTAS.map(a=>`<option value="${a.nombre}">${a.nombre}</option>`).join('');
    })();

    /* ==================== AUTOCOMPLETE USUARIOS ==================== */
    const inputUsuario = $('#usuario'); const acList = $('#acList');
    const norm = (s)=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    function filtraUsuarios(q){ const n=norm(q); if(!n) return []; return USUARIOS.filter(u=>norm(u).includes(n)).slice(0,8); }
    function pintaLista(items){ if(!items.length){ acList.hidden=true; acList.innerHTML=''; return; } acList.innerHTML=items.map((t,i)=>`<li ${i===0?'aria-selected="true"':''}>${t}</li>`).join(''); acList.hidden=false; }
    inputUsuario.addEventListener('input', ()=> pintaLista(filtraUsuarios(inputUsuario.value)));
    inputUsuario.addEventListener('focus', ()=> pintaLista(filtraUsuarios(inputUsuario.value)));
    document.addEventListener('click', (e)=>{ if (e.target.closest('#acList li')){ inputUsuario.value = e.target.textContent; acList.hidden = true; } else if(!e.target.closest('.ac')) { acList.hidden = true; } });

    /* ===== Plantillas: insertar en cursor ===== */
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.snippet-btn');
      if (!btn) return;
      const txt = btn.getAttribute('data-snippet') || '';
      const area = $('#descripcion');
      const {selectionStart:s, selectionEnd:ePos, value:v} = area;
      area.value = v.slice(0,s) + txt + v.slice(ePos);
      area.focus(); area.selectionStart = area.selectionEnd = s + txt.length;
    });

    /* ==================== REQUERIMIENTO UI ==================== */
    const reqSi = $('#reqSi'), reqNo = $('#reqNo'), reqNumber = $('#reqNumber');
    function toggleReq(){ reqNumber.style.display = reqSi.checked ? '' : 'none'; }
    reqSi.addEventListener('change', toggleReq); reqNo.addEventListener('change', toggleReq);

    /* ==================== FILTROS ==================== */
    (function fillMonths(){
      const now = new Date(); const items = ['<option value="">Todos</option>'];
      for (let i=0;i<12;i++){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        const label = d.toLocaleDateString('es-CO', { month:'long', year:'numeric' });
        items.push(`<option value="${ym}">${label}</option>`);
      }
      monthSelect.innerHTML = items.join('');
    })();
    (function initView(){
      const saved = JSON.parse(localStorage.getItem('tickets_view')||'{}');
      viewSelect.value   = saved.view || 'mis';
      analystSelect.value= saved.analyst || '';
      statusSelect.value = saved.status || '';
      monthSelect.value  = saved.month || '';
    })();
    function persistView(){ localStorage.setItem('tickets_view', JSON.stringify({ view:viewSelect.value, analyst:analystSelect.value, status:statusSelect.value, month:monthSelect.value })); }
    [viewSelect,analystSelect,statusSelect,monthSelect].forEach(el => el.addEventListener('change', ()=>{ persistView(); fetchRemote(); }));

    /* ==================== BUSCADOR RÁPIDO ==================== */
    quickSearch.addEventListener('input', ()=>{ searchText = quickSearch.value; render(); });

    /* ==================== HELPERS ==================== */
    const show = (msg, kind='ok')=>{
      notice.style.display='block'; notice.textContent=msg;
      notice.style.borderColor=(kind==='ok')?'#b2f2bb':'#ffc9c9';
      setTimeout(()=> notice.style.display='none', 2200);
    };
    const esc = s => String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
    const trunc = (s,len=30)=>{ const t=String(s||''); return t.length>len ? t.slice(0,len)+'…' : t; };
    const badge = p => `<span class="badge ${p==='Alta'?'prio-alta':p==='Media'?'prio-media':'prio-baja'}">${p||''}</span>`;
    const tagE  = e => { const s = String(e||''); const cls = (s==='Abierto')?'e-abierto':(s==='En Proceso')?'e-proceso':(s==='Cerrado')?'e-cerrado':'e-cancelado'; return `<strong class="${cls}">${s}</strong>`; };
    const fmt = iso => { const d = (iso instanceof Date) ? iso : new Date(iso); return isNaN(d) ? '' : d.toLocaleString(); };

    function computeCounters(rows){
      const c = { total:rows.length, abiertos:0, en_proceso:0, cerrados:0, cancelados:0, con_req:0 };
      rows.forEach(t=>{
        const s=String(t.estado||'').toLowerCase();
        if(s==='abierto') c.abiertos++; else if(s==='en proceso') c.en_proceso++; else if(s==='cerrado') c.cerrados++; else if(s==='cancelado') c.cancelados++;
        if (t.requerimiento) c.con_req++;
      });
      return c;
    }
    function setCounters(c){ kpiTotal.textContent=c.total; kpiAb.textContent=c.abiertos; kpiPr.textContent=c.en_proceso; kpiCe.textContent=c.cerrados; kpiCa.textContent=c.cancelados; kpiRq.textContent=c.con_req||0; }

    function currentBaseRows(){
      const base = Array.isArray(ticketsRemote) ? ticketsRemote : ticketsLocal;
      lastSource = Array.isArray(ticketsRemote) ? 'Sheets' : 'Local';
      let rows = base.slice();
      const st = statusSelect.value;
      if (st==='pendientes'){ rows = rows.filter(x => !['Cerrado','Cancelado'].includes(String(x.estado))); }
      else if (st) rows = rows.filter(x => String(x.estado)===st);
      if (analystSelect.value) rows = rows.filter(x => String(x.analista)===analystSelect.value);
      if (monthSelect.value){
        rows = rows.filter(x => {
          const d = new Date(x.fecha);
          const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          return ym === monthSelect.value;
        });
      }
      return rows;
    }
    function currentRows(){
      let rows = currentBaseRows();
      if (searchText && searchText.trim()){
        const n = searchText.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        rows = rows.filter(r =>
          (`${r.id} ${r.categoria} ${r.falla} ${r.usuario} ${r.descripcion||''}`).toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
            .includes(n)
        );
      }
      rows.sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
      return rows;
    }

    /* ========= render: incluye columna "Descripción" (truncada + clic) y "Fecha cierre" ========= */
    function render(countersFromAPI){
      const rows = currentRows();
      if (countersFromAPI && lastSource==='Sheets') setCounters(countersFromAPI);
      else setCounters(computeCounters(rows));

      syncBadge.innerHTML = `Fuente: <strong>${lastSource}</strong>`;

      tbody.innerHTML = rows.length ? rows.map(t=>`
        <tr>
          <td>${t.id||''}</td>
          <td>${esc(t.analista||'')}</td>
          <td>${esc(t.categoria||'')}</td>
          <td>${esc(t.falla||'')}</td>
          <td>${esc(t.usuario||'')}</td>

          <!-- Descripción (30 chars) con data-full para abrir modal -->
          <td>
            ${t.descripcion
              ? `<span class="desc-peek" data-id="${t.id}" data-full="${esc(t.descripcion)}" title="Ver descripción completa">${esc(trunc(t.descripcion,30))}</span>`
              : '<span class="muted">—</span>'}
          </td>

          <td>${badge(t.prioridad||'')}</td>
          <td>${tagE(t.estado||'')}</td>

          <!-- Fecha de creación y fecha de cierre -->
          <td>${fmt(t.fecha)}</td>
          <td>${t.fechaCierre ? fmt(t.fechaCierre) : '<span class="muted">—</span>'}</td>

          <td style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <select class="estado-select" data-id="${t.id}">
              <option ${t.estado==='Abierto'?'selected':''}>Abierto</option>
              <option ${t.estado==='En Proceso'?'selected':''}>En Proceso</option>
              <option ${t.estado==='Cerrado'?'selected':''}>Cerrado</option>
              <option ${t.estado==='Cancelado'?'selected':''}>Cancelado</option>
            </select>
            <select class="prio-select" data-id="${t.id}">
              <option ${t.prioridad==='Alta'?'selected':''}>Alta</option>
              <option ${t.prioridad==='Media'?'selected':''}>Media</option>
              <option ${t.prioridad==='Baja'?'selected':''}>Baja</option>
            </select>
          </td>
        </tr>`).join('') : `<tr><td colspan="11" style="text-align:center;color:#51608b">Sin resultados</td></tr>`;
    }

    /* ==================== WHOAMI + LIST + CONTACTS ==================== */
    async function fetchWhoAmI(){
      try{
        const params = new URLSearchParams({ action:'whoami' });
        if (AUTH_KEY) params.set('key', AUTH_KEY);
        const res = await fetch(WEB_APP_URL + '?' + params.toString());
        const data = await res.json();
        identity = data && data.ok ? data.me : null;
        who.textContent = identity ? `Identidad: ${identity.name} (${identity.role})` : 'Identidad: (no detectada)';
        const isAdmin = identity && identity.role==='admin';
        viewSelect.disabled = !isAdmin; if (!isAdmin) viewSelect.value = 'mis';
        if (identity && !analystSelect.value) analystSelect.value = identity.name;
      }catch{ identity = null; who.textContent = 'Identidad: (no detectada)'; }
    }
    async function fetchRemote(){
      try{
        const params = new URLSearchParams();
        params.set('action','list');
        params.set('view', viewSelect.value);
        if (analystSelect.value) params.set('analyst', analystSelect.value);
        if (statusSelect.value==='pendientes') params.set('state','pendientes');
        else if (statusSelect.value) params.set('status', statusSelect.value);
        if (monthSelect.value) params.set('ym', monthSelect.value);
        params.set('limit','1500');
        if (AUTH_KEY) params.set('key', AUTH_KEY);
        const res = await fetch(WEB_APP_URL + '?' + params.toString());
        const data = await res.json();
        if (data && data.ok && Array.isArray(data.items)){
          ticketsRemote = data.items;
          if (data.me){ identity = data.me; who.textContent = `Identidad: ${identity.name} (${identity.role})`; }
          render(data.counters);
        } else { ticketsRemote = null; render(); }
      }catch(err){ ticketsRemote = null; render(); }
    }

    /* Cargar contactos de Sheets para autocomplete */
    async function fetchContacts(){
      try{
        const params = new URLSearchParams({ action:'contacts' });
        if (AUTH_KEY) params.set('key', AUTH_KEY);
        const res = await fetch(WEB_APP_URL + '?' + params.toString());
        const data = await res.json();
        if (data && data.ok && Array.isArray(data.contacts) && data.contacts.length){
          USUARIOS = data.contacts; // reemplaza catálogo local
        }
      }catch(e){ /* fallback al arreglo local */ }
    }

    /* ==================== POST ==================== */
    async function postJSON(payload){
      if (AUTH_KEY) payload.key = AUTH_KEY;
      const res = await fetch(WEB_APP_URL, { method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });
      try { return await res.json(); } catch { return { ok:false, error:'Respuesta no-JSON' }; }
    }

    /* ==================== CREAR TICKET ==================== */
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const analista   = $('#analista').value;
      const categoria  = $('#categoria').value;
      const falla      = $('#falla').value;
      const usuario    = $('#usuario').value.trim();
      const prioridad  = $('#prioridad').value;
      const descripcion= $('#descripcion').value.trim();

      // Validación de “Requerimiento”
      const tieneReq = $('#reqSi').checked;
      const reqNum   = $('#reqNumber').value.trim();
      if (tieneReq && !reqNum){ show('Escribe el número de requerimiento','err'); $('#reqNumber').focus(); return; }

      if(!analista || !categoria || !falla || !usuario || !prioridad){
        show('Completa los campos obligatorios','err'); return;
      }

      const correoAnalista = (ANALISTAS.find(a=>a.nombre===analista)?.email) || '';
      const id = 'T' + new Date().toISOString().replace(/\D/g,'').slice(0,14);
      const nowISO = new Date().toISOString();

      // Guardamos local primero (Fecha = creación)
      const t = { id, analista, correoAnalista, categoria, falla, usuario, prioridad, descripcion,
                  requerimiento: tieneReq ? `REQ-${reqNum}` : '', estado:'Abierto', fecha: nowISO,
                  fechaCierre: '' };
      ticketsLocal.unshift(t); saveLocal(ticketsLocal); render(); show('Guardado local. Enviando a Sheets…');

      // Enviar a Sheets
      const d = await postJSON({
        action:'create', id:t.id, analista, correoAnalista, categoria, falla, usuario, prioridad,
        descripcion, estado:t.estado, fechaISO: nowISO, requerimiento: t.requerimiento
      });
      if (!d || !d.ok){ show('No se pudo crear en Sheets', 'err'); } else { fetchRemote(); }
      form.reset(); toggleReq();
    });


 /* ==================== MODAL REUTILIZABLE ==================== */
function askModal({
  title,
  label,
  placeholder='',
  required=false,
  readonly=false,
  okText='Aceptar',
  prefill=''            // ← NUEVO: texto inicial opcional
}){
  return new Promise(resolve=>{
    modalTitle.textContent = title;
    modalLabel.textContent = label;

    // Cargar el texto inicial (si viene). No lo borres.
    modalText.value = (typeof prefill === 'string') ? prefill : '';
    modalText.placeholder = placeholder || '';
    modalText.required = required;
    modalText.readOnly = !!readonly;
    modalOk.textContent = okText;

    const onOk = ()=>{
      if(required && !modalText.value.trim()){ modalText.focus(); return; }
      cleanup(); modal.close();
      resolve({ok:true, text: modalText.value.trim()});
    };
    const onCancel = ()=>{ cleanup(); modal.close(); resolve({ok:false}); };
    function cleanup(){
      modalOk.removeEventListener('click', onOk);
      modalCancel.removeEventListener('click', onCancel);
      modal.removeEventListener('cancel', onCancel);
    }
    modalOk.addEventListener('click', onOk);
    modalCancel.addEventListener('click', onCancel);
    modal.addEventListener('cancel', onCancel);
    modal.showModal();
    setTimeout(()=>modalText.focus(), 50);
  });
}

    /* Guardar valor previo del select para revertir si se cancela */
    document.addEventListener('focusin',(e)=>{
      const s = e.target.closest('.estado-select');
      if (s) s.dataset.prev = s.value;
    });

    /* ==================== CLICK EN DESCRIPCIÓN (abrir modal solo lectura) ==================== */
document.addEventListener('click', (e)=>{
  const peek = e.target.closest('.desc-peek');
  if (!peek) return;
  const full = peek.dataset.full || '';
  // Pasar el contenido como prefill para que no se borre
  askModal({
    title:'Descripción completa',
    label:'Descripción',
    readonly:true,
    okText:'Cerrar',
    prefill: full
  });
});


    /* ==================== CAMBIOS ESTADO / PRIORIDAD ==================== */
    document.addEventListener('change', async (e)=>{
      const selE = e.target.closest('.estado-select');
      const selP = e.target.closest('.prio-select');

      if (selE){
        const id = selE.dataset.id;
        const newStatus = selE.value;
        const prev = selE.dataset.prev || 'Abierto';

        if (newStatus === 'Cancelado'){
          const r = await askModal({title:'Cancelar ticket', label:'Motivo de cancelación', placeholder:'Describe el motivo…', required:true});
          if (!r.ok){ selE.value = prev; return; }
          const tL = ticketsLocal.find(x=>x.id===id);
          if (tL){ tL.estado=newStatus; tL.motivo=r.text; saveLocal(ticketsLocal); }
          render();
          const d = await postJSON({ action:'update_status', id, status:newStatus, reason:r.text });
          if (d && d.ok) fetchRemote();
          return;
        }

        if (newStatus === 'Cerrado'){
          const r = await askModal({title:'Cerrar ticket', label:'Solución aplicada', placeholder:'Describe la solución brindada…', required:true});
          if (!r.ok){ selE.value = prev; return; }
          const tL = ticketsLocal.find(x=>x.id===id);
          if (tL){ tL.estado=newStatus; tL.solucion=r.text; tL.fechaCierre = new Date().toISOString(); saveLocal(ticketsLocal); }
          render();
          const d = await postJSON({ action:'update_status', id, status:newStatus, solution:r.text });
          if (d && d.ok) fetchRemote();
          return;
        }

        // Otros estados
        const tL = ticketsLocal.find(x=>x.id===id);
        if (tL){ tL.estado=newStatus; /* no tocamos fechas */ saveLocal(ticketsLocal); }
        render();
        const d2 = await postJSON({ action:'update_status', id, status:newStatus });
        if (d2 && d2.ok) fetchRemote();
      }

      if (selP){
        const id = selP.dataset.id; const pr = selP.value;
        const tL = ticketsLocal.find(x=>x.id===id);
        if (tL){ tL.prioridad=pr; saveLocal(ticketsLocal); }
        render();
        const d3 = await postJSON({ action:'update_priority', id, prioridad: pr });
        if (d3 && d3.ok) fetchRemote();
      }
    });

    /* ==================== INIT ==================== */
    async function init(){
      await fetchWhoAmI();
      await fetchContacts();     // trae usuarios desde Sheets
      if (identity && !analystSelect.value) analystSelect.value = identity.name;
      render();
      fetchRemote();
      setInterval(()=>{ if(!document.hidden) fetchRemote(); }, AUTO_REFRESH_MS);
    }
    init();
  })();
  </script>
</body>
</html>


















